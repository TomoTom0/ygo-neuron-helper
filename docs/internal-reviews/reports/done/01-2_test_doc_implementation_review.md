# レビュー報告書: テストとドキュメント実装レビュー（01-2）

## 総合評価

条件付き承認。
- 理由: ユニットテストとドキュメントは広範にカバーされており品質は高いが、E2Eテスト未実装と一部モック/環境設定に関する懸念があるため、修正を条件として承認する。

## 要約

- 実装: 122ユニットテスト、4本の主要ドキュメント、テストフィクスチャを追加。
- テスト結果: 全テストパス（提供された出力のとおり）。
- 主な懸念: E2E欠如、`happy-dom`/Node 環境差異、`chrome.storage.local` モックの差異。

## 詳細評価

### 1) テストカバレッジと品質

- カバレッジ: 主要ユーティリティ（PNGメタデータ、インポート/エクスポート、URL状態、設定ストア）を重点的にカバーしており、実用上十分な範囲に見える。
- エッジケース: PNGの無効シグネチャや特殊文字等のエッジケースがテストされている点は良い。
- 可読性: テストは目的別に分割されており読みやすい想定だが、いくつかの長いフィクスチャセットで説明コメントがあると保守性が上がる。
- モックの使い方: `chrome.storage.local` のモックは基本的に妥当だが、非同期コールバックやエラー発生時の挙動をより明示的にテストすると良い。

指摘事項（テスト）:
- `url-state` のテストでエンコーディング周り（特殊文字、長いクエリ値）を追加で実行することを推奨。
- `stores/settings` のテストで並列実行時の競合ケース（同時に set/get が呼ばれる）を追加検討。

### 2) ドキュメントの品質

- ユーザー向け: 手順、FAQ、トラブルシューティングが用意されており実用的。スクリーンショット等があると更に親切。
- 開発者向け: 技術仕様とデータモデルは詳細で良い。だが行数が多いうえに一部は実装と乖離すると保守コストが増すため、以下の改善を推奨。

指摘事項（ドキュメント）:
- `docs/dev/png-format-spec.md` にある CRC 実装の擬似コードが現行実装と一致するか確認を促す注記を追加してください。
- `docs/dev/data-models.md` の型定義にソースコードの参照リンク（`src/types` 等）を追加して乖離を早期検出できるようにしてください。

### 3) 実装の一貫性

- 命名・スタイル: 既存コードと大きなズレは見られない（提供内容に基づく）。
- エラーメッセージ: ユーザー向けの文言が一貫しているか確認するため、ドキュメント中の例と実際のコードで発生するメッセージが一致するサンプルを示すことを推奨。

### 4) 欠落している要素

- E2E テスト: デッキ編集→エクスポート→インポートの実際のフローを検証する E2E を少なくとも1本追加することを強く推奨します（優先度: 高）。
- Vue コンポーネントの重要ロジックに対するスナップショットやユニットテストが不足している可能性あり（優先度: 中）。

### 5) テスト環境とモックに関する懸念

- `vitest` 環境で `happy-dom` を使用している点はブラウザAPIの互換を高めるが、Node 環境での差異が出る関数（例: `File` / `Blob` / `window.location`）は統一した確認が必要。
- `chrome.storage.local` モックは形だけでなく、レイテンシやエラーを模したテストを追加すると実運用に近づきます。

## 重要指摘（優先度順）

1. E2E テストを最低1つ追加する（デッキ編集→エクスポート→インポート）— 優先度: 高
2. `chrome.storage.local` モックで非同期・エラーケースをカバーする追加テスト — 優先度: 高
3. ドキュメントの技術仕様と実装の整合性チェック（型定義・CRC 擬似コード等） — 優先度: 中
4. `url-state` と `stores/settings` における特殊文字／競合ケースの追加テスト — 優先度: 中
5. 開発者ドキュメントにソース参照リンクと要約セクションを追加して保守性を向上 — 優先度: 低

## 提案する修正案（短期）

- CI に E2E のスモークテスト（Playwright/Chromium）を追加し、PR 単位で重要フローを検証する。
- `chrome.storage` モックユーティリティを共通ヘルパー化してテスト間で一貫した動作を担保する。
- ドキュメントに「実装とドキュメントの差分を検出するチェックリスト」を追加する。

## 推奨アクション（次のステップ）

1. E2E テスト1本を作成し、PR に追加する（期限: レビュー修正期間内推奨）。
2. `chrome.storage.local` モックの追加テストを実装する。
3. ドキュメントにソース参照を追加する。
4. 指摘事項を反映した改訂版を提出し再レビューを依頼する。

## 添付: 参考チェックリスト

- URL エンコード（UTF-8）確認
- PNG tEXt の多バイト文字テスト
- CRC-32 の境界ケース検証（長データ）
- storage の非同期エラー発生時の復旧処理


---

作成者: レビュー自動支援エージェント
