# 多言語対応 (i18n) ガイド

## 概要

YGO Deck Helper は日本語版・英語版の遊戯王公式サイトに対応しています。
本ドキュメントでは、多言語対応の実装方法とメンテナンス方法を説明します。

## サポート言語

- **日本語 (ja)**: デフォルト言語
- **英語 (en)**: 完全対応

## アーキテクチャ

### 1. 言語検出

`src/utils/language-detector.ts` が自動的にページ言語を検出します。

**検出優先順位:**
```typescript
1. #nowlanguage 要素の data-lang 属性
   例: <div id="nowlanguage" data-lang="en">
   
2. <meta property="og:url"> の request_locale パラメータ
   例: <meta property="og:url" content="...?request_locale=en">
   
3. URL クエリパラメータ request_locale
   例: ?request_locale=en
   
4. デフォルト値: "ja"
```

**使用例:**
```typescript
import { detectLanguage } from './utils/language-detector';

const lang = detectLanguage(document); // 'ja' or 'en'
```

### 2. マッピング管理

`src/utils/mapping-manager.ts` が言語別のマッピングテーブルを管理します。

**マッピング対象:**
- 属性 (Attribute)
- 種族 (Race/Type)
- モンスタータイプ (Monster Type)
- エフェクトタイプ (Effect Type)
- リンクマーカー (Link Markers)

**マッピング構造:**
```typescript
interface LanguageMappings {
  [language: string]: {
    [key: string]: string;
  };
}

const attributeMappings: LanguageMappings = {
  ja: {
    '光': 'LIGHT',
    '闇': 'DARK',
    '地': 'EARTH',
    // ...
  },
  en: {
    'LIGHT': 'LIGHT',
    'DARK': 'DARK',
    'EARTH': 'EARTH',
    // ...
  }
};
```

**使用例:**
```typescript
import { MappingManager } from './utils/mapping-manager';

const manager = new MappingManager('ja');
const normalized = manager.getAttribute('光'); // 'LIGHT'

const managerEn = new MappingManager('en');
const normalized2 = managerEn.getAttribute('LIGHT'); // 'LIGHT'
```

### 3. パーサーの多言語対応

各パーサーは `MappingManager` を使用してテキストを正規化します。

**例: card-search.ts**
```typescript
export async function parseCardSearchResult(
  html: string,
  language: string = 'ja'
): Promise<Card[]> {
  const manager = new MappingManager(language);
  
  // パース処理
  cards.forEach(card => {
    // テキストベース判定
    card.attribute = manager.getAttribute(rawAttribute);
    card.race = manager.getRace(rawRace);
    
    // 画像ベース判定 (言語非依存)
    card.cardType = detectCardTypeFromIcon(iconUrl);
  });
}
```

## 言語別の違い

### テキスト記号

| 項目 | 日本語 | 英語 |
|------|--------|------|
| 角括弧 | 【】 | [] |
| スラッシュ | ／ (全角) | ／ (全角) |

### 属性名

| 日本語 | 英語 | 正規化後 |
|--------|------|----------|
| 光 | LIGHT | LIGHT |
| 闇 | DARK | DARK |
| 地 | EARTH | EARTH |
| 水 | WATER | WATER |
| 炎 | FIRE | FIRE |
| 風 | WIND | WIND |
| 神 | DIVINE | DIVINE |

### 種族名

| 日本語 | 英語 | 正規化後 |
|--------|------|----------|
| ドラゴン族 | Dragon | Dragon |
| 機械族 | Machine | Machine |
| 魔法使い族 | Spellcaster | Spellcaster |
| 戦士族 | Warrior | Warrior |
| ... | ... | ... |

### モンスタータイプ

| 日本語 | 英語 | 正規化後 |
|--------|------|----------|
| 通常 | Normal | Normal |
| 効果 | Effect | Effect |
| 儀式 | Ritual | Ritual |
| 融合 | Fusion | Fusion |
| シンクロ | Synchro | Synchro |
| エクシーズ | Xyz | Xyz |
| ペンデュラム | Pendulum | Pendulum |
| リンク | Link | Link |

## 新しい言語を追加する方法

### 1. マッピングテーブルの追加

`src/utils/mapping-manager.ts` にマッピングを追加:

```typescript
const attributeMappings: LanguageMappings = {
  ja: { /* 既存 */ },
  en: { /* 既存 */ },
  ko: {  // 韓国語を追加
    '빛': 'LIGHT',
    '어둠': 'DARK',
    // ...
  }
};
```

### 2. テストデータの追加

`tests/fixtures/` に該当言語のHTMLサンプルを追加:

```
tests/fixtures/
├─ card-search-ja.html
├─ card-search-en.html
└─ card-search-ko.html  # 新規追加
```

### 3. テストの追加

`tests/integration/` にテストを追加:

```typescript
describe('Card Search Parser (Korean)', () => {
  it('should parse Korean card search results', async () => {
    const html = readFileSync('tests/fixtures/card-search-ko.html', 'utf-8');
    const cards = await parseCardSearchResult(html, 'ko');
    
    expect(cards[0].attribute).toBe('LIGHT');
    // ...
  });
});
```

### 4. ドキュメント更新

このファイルに新しい言語のマッピング表を追加。

## 画像ベース判定

以下の項目は**言語非依存**で画像URLから判定します:

### カードタイプ判定

```typescript
// アイコンURL例:
// - /icon/icon_ver_magic.gif → 'spell'
// - /icon/icon_ver_trap.gif → 'trap'
// - その他 → 'monster'

function detectCardTypeFromIcon(iconUrl: string): CardType {
  if (iconUrl.includes('icon_ver_magic')) return 'spell';
  if (iconUrl.includes('icon_ver_trap')) return 'trap';
  return 'monster';
}
```

### リンクマーカー判定

```typescript
// リンクマーカー画像URL例:
// - /images/CardList_Link_01_p_on.png → 左下
// - /images/CardList_Link_02_p_on.png → 下
// - /images/CardList_Link_03_p_on.png → 右下
// ...

function detectLinkMarkers(linkImages: string[]): LinkMarker[] {
  const markers: LinkMarker[] = [];
  linkImages.forEach(url => {
    if (url.includes('Link_01_p_on')) markers.push('bottom-left');
    if (url.includes('Link_02_p_on')) markers.push('bottom');
    // ...
  });
  return markers;
}
```

## テキスト記号の違い

### 角括弧の処理

```typescript
// 日本語: 【効果モンスター】
// 英語: [Effect Monster]

function extractBracketedText(text: string, language: string): string {
  if (language === 'ja') {
    const match = text.match(/【(.+?)】/);
    return match ? match[1] : '';
  } else {
    const match = text.match(/\[(.+?)\]/);
    return match ? match[1] : '';
  }
}
```

### スラッシュの処理

日本語・英語ともに全角「／」を使用:

```typescript
// 日本語: ドラゴン族／効果
// 英語: Dragon／Effect

const parts = text.split('／');
const race = parts[0];
const type = parts[1];
```

## フォールバック処理

マッピングが見つからない場合のフォールバック:

```typescript
class MappingManager {
  getAttribute(attr: string): string {
    const mapping = this.attributeMappings[this.language];
    
    // 1. マッピング検索
    if (mapping[attr]) {
      return mapping[attr];
    }
    
    // 2. そのまま返す (英語版の場合など)
    console.warn(`Attribute mapping not found for "${attr}" in ${this.language}`);
    return attr;
  }
}
```

## デバッグ

### 言語検出の確認

```javascript
// ブラウザコンソールで実行
const langElement = document.querySelector('#nowlanguage');
console.log('Detected language:', langElement?.dataset.lang);

const metaOgUrl = document.querySelector('meta[property="og:url"]');
console.log('Meta og:url:', metaOgUrl?.getAttribute('content'));
```

### マッピングの確認

```javascript
// 開発者ツールで MappingManager を使用
import { MappingManager } from './utils/mapping-manager';

const manager = new MappingManager('ja');
console.log('光 →', manager.getAttribute('光')); // 'LIGHT'

const managerEn = new MappingManager('en');
console.log('LIGHT →', managerEn.getAttribute('LIGHT')); // 'LIGHT'
```

## メンテナンス

### マッピングの更新

新しいカード種族やタイプが追加された場合:

1. `src/utils/mapping-manager.ts` にマッピング追加
2. テストケース追加
3. ドキュメント更新

### 公式サイトの変更監視

公式サイトのHTML構造が変更された場合:

1. パーサー修正 (`src/api/*.ts`)
2. テストフィクスチャ更新 (`tests/fixtures/*.html`)
3. テスト実行・修正

## トラブルシューティング

### Q: 言語が正しく検出されない

**A:** 以下を確認:
1. `#nowlanguage[data-lang]` が存在するか
2. `<meta property="og:url">` に `request_locale` が含まれているか
3. URL に `request_locale` パラメータがあるか

### Q: マッピングが見つからないエラー

**A:** 
1. コンソールの警告を確認
2. 該当のテキストを `mapping-manager.ts` に追加
3. テスト追加

### Q: 英語版でカード情報が正しく取得できない

**A:**
1. `tests/integration/card-detail-en.test.ts` を確認
2. HTML構造が変わっていないか確認
3. マッピングが正しいか確認

## 参考資料

- [言語検出実装](../../src/utils/language-detector.ts)
- [マッピング管理実装](../../src/utils/mapping-manager.ts)
- [カード検索パーサー](../../src/api/card-search.ts)
- [デッキ詳細パーサー](../../src/api/deck-detail-parser.ts)
- [多言語調査結果](../research/i18n-investigation.md)
