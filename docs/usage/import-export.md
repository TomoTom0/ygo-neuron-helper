# デッキのインポート・エクスポート機能

YGO Deck Helperでは、デッキ情報を複数の形式でエクスポート・インポートできます。

## 対応フォーマット

### 1. CSV形式（.csv）
カンマ区切りのテキストファイルで、スプレッドシートアプリケーションでも編集可能です。

**フォーマット:**
```csv
section,name,cid,ciid,quantity
main,灰流うらら,12950,1,2
main,増殖するG,4861,2,1
extra,PSYフレームロード・Λ,9753,1,1
side,屋敷わらし,14558,1,3
```

**フィールド説明:**
- `section`: デッキセクション（`main`, `extra`, `side`）
- `name`: カード名（オプション、インポート時は無視）
- `cid`: カードID（必須）
- `ciid`: カードイラストID（必須、通常は`1`）
- `quantity`: 枚数（必須、1-3枚）

**特徴:**
- ヘッダー行は任意（あってもなくても動作）
- `name`列は省略可能
- カンマを含むカード名はダブルクォートで囲む（`"Card, Name"`）
- スプレッドシートで編集・管理が容易

### 2. TXT形式（.txt）
人間が読みやすいテキスト形式です。

**フォーマット:**
```
=== Main Deck ===
2x 灰流うらら (12950:1)
1x 増殖するG (4861:2)

=== Extra Deck ===
1x PSYフレームロード・Λ (9753:1)

=== Side Deck ===
3x 屋敷わらし (14558:1)
```

**フォーマット詳細:**
- セクションヘッダー: `=== [Section Name] Deck ===`
- カード行: `[枚数]x [カード名] ([cid]:[ciid])`
- 拡張形式（imgHash付き）: `[枚数]x [カード名] ([cid]:[ciid]:[imgHash])`

**特徴:**
- テキストエディタで直接編集可能
- 視認性が高く、メモ帳などで確認しやすい
- 空行は自動的にスキップ

### 3. PNG形式（.png）
デッキ画像にデッキ情報を埋め込みます。画像の見た目は変わりません。

**特徴:**
- デッキレシピ画像として共有しながら、デッキ情報も保持
- PNG tEXtチャンク（メタデータ領域）にJSON形式で保存
- 画像の画質や見た目に影響なし
- SNSやDiscordで共有してもデータが保持される

**埋め込まれるデータ:**
- カードID（`cid`）
- イラストID（`ciid`）
- 画像ハッシュ（`imgHash`）
- 枚数（`quantity`）
- セクション情報（main/extra/side）

## エクスポート方法

### 1. デッキ編集画面から
1. デッキ編集画面を開く
2. 右上のメニューアイコン（⋮）をクリック
3. "Export Deck" を選択
4. 希望の形式を選択（CSV/TXT/PNG）
5. オプション設定:
   - **Include Side Deck**: サイドデッキを含めるか（デフォルト: 有効）
   - ファイル名を入力
6. "Export" ボタンをクリック

### 2. デッキ表示画面から
1. デッキ表示ページを開く
2. 画面下部の "Create Deck Image" ボタンをクリック
3. PNG形式でエクスポート（デッキ情報が埋め込まれます）

### エクスポート時の注意点
- **CSV/TXT**: テキストエディタで編集可能だが、フォーマットを守る必要あり
- **PNG**: デッキ画像として共有しながらデータも保持できる
- サイドデッキを含めない設定も可能（CSV/TXT）

## インポート方法

### 1. ファイルを選択してインポート
1. デッキ編集画面を開く
2. 右上のメニューアイコン（⋮）をクリック
3. "Import Deck" を選択
4. ファイル選択ダイアログでファイルを選択
5. インポート結果を確認
6. 警告がある場合は内容を確認

### 2. ドラッグ&ドロップでインポート
1. デッキ編集画面を開く
2. ファイル（CSV/TXT/PNG）を画面にドラッグ&ドロップ
3. インポート結果を確認

### インポート時の挙動
- **成功時**: デッキ情報が読み込まれ、現在のデッキと置き換わります
- **警告あり**: 一部の行がスキップされた場合、警告メッセージが表示されます
- **失敗時**: エラーメッセージが表示され、デッキは変更されません

### 対応形式の自動判定
拡張子から自動的にフォーマットを判定します:
- `.csv` → CSV形式
- `.txt` → TXT形式
- `.png` → PNG形式（埋め込みデータ）

## トラブルシューティング

### CSV/TXTインポート時のエラー

#### "ファイルが空です"
- ファイルに内容がないか、空行のみです
- 正しいフォーマットでカード情報を記述してください

#### "インポート可能なデータがありません"
- すべての行が不正なフォーマットです
- フォーマット例を参考に修正してください

#### 警告: "行X: CSVのパースに失敗しました"
- その行のフォーマットが不正です
- カンマ区切りが正しいか確認してください
- フィールド数が合っているか確認してください

#### 警告: "行X: フォーマットが不正です"（TXT）
- TXT形式の行フォーマットが不正です
- `[枚数]x [カード名] ([cid]:[ciid])` の形式を確認してください

### PNGインポート時のエラー

#### "PNG画像からデッキ情報を抽出できませんでした"
- PNG画像にデッキ情報が埋め込まれていません
- YGO Deck Helperでエクスポートした画像か確認してください
- 画像編集ソフトで加工すると、メタデータが失われる場合があります

#### "PNG読み込みエラー"
- ファイルが破損しているか、PNG形式ではありません
- ファイルを再度ダウンロードしてください

### よくある質問

**Q: CSVでカード名にカンマが含まれる場合は？**
A: ダブルクォートで囲んでください。例: `"Card, Name"`

**Q: TXTでカード名に括弧が含まれる場合は？**
A: 問題ありません。`(cid:ciid)` の括弧は行末にあるため、カード名内の括弧と区別できます。

**Q: PNGのメタデータはどのツールで確認できますか？**
A: ExifTool などのメタデータ閲覧ツールで tEXtチャンクを確認できます。

**Q: PNGの画質は劣化しますか？**
A: いいえ。tEXtチャンクはメタデータ領域に保存されるため、画像データには一切影響しません。

**Q: サイドデッキを含めたくない場合は？**
A: エクスポート時に "Include Side Deck" のチェックを外してください（CSV/TXT）。

**Q: Rush Duel形式のデッキも対応していますか？**
A: はい。Rush DuelとOCGの両方に対応しています。形式は自動判定されます。

**Q: インポート時に既存のデッキは上書きされますか？**
A: はい。インポート前に確認ダイアログが表示されます。

**Q: エクスポートしたファイルを編集できますか？**
A: CSV/TXTは編集可能です。ただし、フォーマットを守る必要があります。PNGは画像なので編集には適していません。

## 技術仕様

### PNG tEXtチャンク
- **キー名**: `DeckInfo`
- **値**: JSON形式（SimpleDeckInfo型）
- **チャンク位置**: IEND チャンクの直前
- **CRC検証**: PNG仕様に準拠

### CSV パーサー
- ダブルクォートのエスケープに対応
- カンマを含むフィールドに対応
- ヘッダー行の自動検出

### TXT パーサー
- セクションヘッダーの柔軟な検出
- 新旧フォーマットの両方に対応
- 空行の自動スキップ

## 参考資料
- [デッキメタデータ機能](./deck-metadata.md)
- [開発者向け: PNG形式仕様](../dev/png-format-spec.md)
- [開発者向け: データモデル](../dev/data-models.md)
