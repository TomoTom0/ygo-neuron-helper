# DONE

完了したタスク

> **注**: 詳細な履歴は `docs/_archived/tasks/done_full_2025-11-07.md` を参照

## 2025-11-14: UI改善・ドキュメント拡充のPR作成完了

### Git作業完了
- ✅ feature/ui-docs-improvements ブランチ作成
- ✅ 全変更をコミット（24ファイル変更）
- ✅ origin へ push 完了
- ✅ PR #6 作成（feature/ui-docs-improvements → dev）
  - URL: https://github.com/TomoTom0/YuGiOh-NEXT/pull/6

**変更サマリー**:
- UI改善（サイドバーナビゲーション、スタイル統一、アイコン更新）
- ドキュメント拡充（Chrome Store画像追加、約2.5MB）
- Repository名変更対応（ygo-neuron-helper → YuGiOh-NEXT）
- 連絡先情報追加、開発効率化

**タイムスタンプ**: 2025-11-14 20:30

---

## 2025-11-14: Chrome Store宣伝画像をドキュメントに追加完了

### Chrome Store宣伝画像の追加
- ✅ tmp/のChrome Store画像3枚をドキュメントに配置
  - `store-promo-01-easy-moving.png`: デッキ編集の操作説明（557KB）
  - `store-promo-02-card-info.png`: カード詳細4タブ表示（608KB）
  - `store-promo-03-viewing-page.png`: デッキ表示ページの追加機能（1.4MB）

- ✅ README.md に画像追加
  - introセクション直後: 全体概要（promo-01）
  - デッキ編集UIセクション: カード詳細情報（promo-02）
  - デッキ表示画面セクション: 追加機能概要（promo-03）

- ✅ docs/usage/ ドキュメントに画像追加
  - `custom-deck-edit.md`: 概要セクションに promo-01、カード詳細セクションに promo-02
  - `deck-show.md`: 冒頭に promo-03
  - `README.md`: 主な機能セクションに promo-01

- ✅ 画像配置とビルド
  - `docs/usage/images/` と `public/images/` 両方に配置
  - ビルド・デプロイ完了（約2.5MB追加）

**方針**: 視覚的インパクト（Chrome Store画像）+ 詳細説明（実スクリーンショット）の併用

**変更ファイル**:
- `README.md`
- `docs/usage/custom-deck-edit.md`
- `docs/usage/deck-show.md`
- `docs/usage/README.md`
- `docs/usage/images/store-promo-*.png` (3枚)
- `public/images/store-promo-*.png` (3枚)

**タイムスタンプ**: 2025-11-14 20:15

---

## 2025-11-14: オプションページにサイドバーナビゲーション追加完了

### サイドバーナビゲーション機能の実装
- ✅ 折りたたみ可能なサイドバーナビゲーションを追加
  - トグルボタン（▶/◀）で開閉可能
  - `position: sticky` でスクロール時も固定表示
  - スムーズなトランジション効果（0.3秒）
  - ホバー時にアクセントカラー（#008cff）表示
  - 折りたたみ時: 50px、展開時: 200px

- ✅ セクション構成の変更
  - 独自デッキ編集画面を公式デッキ表示ページより上に配置
  - セクションIDを追加（#deck-edit-screen、#deck-display-page）
  - スムーズスクロール機能を実装

- ✅ アクセス方法の追加
  - ポップアップからのアクセス方法を記載
  - コンテキストメニューからのアクセス方法を記載

- ✅ デザイン統一
  - 白背景 (#f0f0f0) とアクセントカラー (#008cff)
  - 微妙な影効果 (0 2px 4px rgba(0, 0, 0, 0.08))
  - 他のUI要素（popup、deck edit）との一貫性を確保

**変更ファイル**:
- `src/options/App.vue`: サイドバー構造とスタイル追加

**タイムスタンプ**: 2025-11-14 20:00

---

## 2025-11-14: docs/usage/ ファイル構造再整理完了

### ファイル構造の再整理 (commit: 7e75520)
- ✅ index.md を削除
- ✅ README.md を新規作成
  - 全体の概要とナビゲーション
  - 各機能へのリンク
- ✅ deck-show.md を新規作成
  - デッキ表示ページの機能（既存機能）
  - カードシャッフル機能
  - デッキ画像作成機能
  - 操作フロー例とトラブルシューティング
- ✅ deck-edit.md → custom-deck-edit.md にリネーム
  - より明確な名前に変更（独自デッキ編集画面）

**新しいファイル構造**:
1. `README.md`: 全体の概要と目次
2. `deck-show.md`: デッキ表示ページの機能（v0.2.0の既存機能）
3. `custom-deck-edit.md`: 独自デッキ編集画面の機能（v0.3.0で追加）

**タイムスタンプ**: 2025-11-14 19:30

---

## 2025-11-14: ドキュメント修正完了

### docs/usage/deck-edit.md のボタン説明修正 (commit: cf84869)
- ✅ 実装と一致しないボタン表記を修正
  - 「+1」→「+」アイコン（実装通り）
  - 「-1」ボタン→削除（実装に存在しない）
  - 「🗑️」→「ゴミ箱アイコン」に修正
  - 機能説明も「全削除」→「ゴミ箱に移動」に修正
  - 「→S」→「S」（矢印なし）
  - 「M/E」→「M」（表示は「M」のみ）

- ✅ 各セクション別のボタン説明を追加
  - デッキ内カード（メイン/エクストラ/サイド）のボタン
  - 検索結果カードのボタン
  - ゴミ箱内カードのボタン

- ✅ 使用例を実装に合わせて修正
  - カード追加方法（M/Sボタン）
  - ゴミ箱への移動と復元方法
  - セクション間の移動方法

### GitHub Release から絵文字削除
- ✅ v0.3.0リリースノートから絵文字を削除
- ✅ v0.3.1リリースノートから絵文字を削除
  - ユーザー向けドキュメントに絵文字は使用しない方針に従う

**タイムスタンプ**: 2025-11-14 19:00

---

## 2025-11-14: v0.3.0/v0.3.1 GitHub Release作成完了

### tagとrelease作成
- ✅ v0.3.0のtagを作成 (commit: 26b125f)
  - デッキ編集機能と多言語対応基盤
  - テスト合計: 135 tests
- ✅ v0.3.1のtagを作成 (commit: 2bd3189, main)
  - カードリンク機能とコード品質改善
  - v0.3.0からの差分リリース
- ✅ tagをリモートにpush
- ✅ GitHub Releaseを作成
  - v0.3.0: https://github.com/TomoTom0/YuGiOh-NEXT/releases/tag/v0.3.0
  - v0.3.1: https://github.com/TomoTom0/YuGiOh-NEXT/releases/tag/v0.3.1

**タイムスタンプ**: 2025-11-14 18:00

---

## 2025-11-14: v0.3.0リリースPR作成完了

### PR#4作成（dev → main）
- ✅ v0.3.0リリースPRを作成 (PR#4)
  - タイトル: "Release v0.3.0: デッキ編集機能と多言語対応基盤"
  - 主な変更点を網羅的に記載
  - CHANGELOG.mdベースのリリースノート
  - URL: https://github.com/TomoTom0/YuGiOh-NEXT/pull/4
- ✅ PR#3マージ済み（feature/v0.3.0-tests → dev）
  - レビューコメント対応完了
  - 2件の指摘に返信投稿
- ✅ devブランチをpull

**タイムスタンプ**: 2025-11-14 05:43

---

## 2025-11-14: PR#3レビュー対応完了

### レビューコメント対応
- ✅ レビューコメント#1: CHANGELOG.mdのプレースホルダーURL修正
  - `yourusername` → `TomoTom0` に修正（3箇所）
- ✅ レビューコメント#2: テストフレームワークをvitestに統一
  - language-detector.test.ts: カスタムtest関数 → vitest形式（9 tests）
  - mapping-manager.test.ts: カスタムtest関数 → vitest形式（16 tests）
  - card-animation.test.ts: すでにvitest形式（変更なし）

**タイムスタンプ**: 2025-11-14 05:27

---

## 2025-11-13: v0.3.0実装完了・PR#2マージ

### Phase 3: デッキ編集UI + 多言語対応基盤

#### デッキ編集UI実装
- ✅ 基本UI実装（Vue + Pinia）
  - DeckEditLayout.vue（メインレイアウト）
  - DeckEditTopBar.vue（トップバー）
  - DeckSection.vue（デッキエリア）
  - RightArea.vue（右サイドバー）
- ✅ カードコンポーネント
  - DeckCard.vue（カード表示・操作）
  - CardList.vue（カードリスト）
  - CardDetail.vue（カード詳細）
  - CardInfo.vue（カード情報タブ）
  - CardQA.vue（Q&Aタブ）
  - CardProducts.vue（収録パックタブ）
- ✅ 状態管理（Pinia）
  - deck-edit.ts（デッキ編集ストア）
  - displayOrder管理（UUID付きカード配列）
  - FLIP アニメーション対応
- ✅ 機能実装
  - カードドラッグ＆ドロップ
  - カード検索（名前/属性/種族等）
  - リスト/グリッド表示切り替え
  - ソート機能（新しい順/古い順/名前順）
  - デッキロード・保存
  - カード詳細表示（Info/Related/Products/QA）
  - 収録パック展開・折りたたみ
  - 関連カード表示
- ✅ UI改善
  - レスポンシブデザイン
  - FLIPアニメーション
  - スクロール最適化
  - ボタンスタイル統一

#### 多言語対応基盤
- ✅ 言語検出
  - language-detector.ts（ページ言語自動検出）
  - #nowlanguage要素、meta og:url、URLパラメータから検出
- ✅ マッピングテーブル
  - 属性・種族・エフェクトタイプのマッピング
  - scripts/setup/generate-card-maps.ts（自動生成スクリプト）
  - mapping-manager.ts（マッピング管理）
- ✅ API多言語対応
  - getCardDetail: 言語引数追加、自動検出
  - saveDeckInternal: request_locale自動検出
  - getDeckDetail: request_locale自動検出
  - getDeckListInternal: request_locale自動検出

#### 型定義改善
- ✅ CardInfo型の改善
  - imageId → ciid に統一
  - ciid/imgs を必須化
  - getCardImageUrl関数追加（型と密結合）

#### コード品質改善（PR#2レビュー対応）
- ✅ .gitignoreに*.dtmp追加
- ✅ imgsパラメータ修正（ciid使用）
- ✅ console.log削除
- ✅ コメントアウトコード削除
- ✅ scrollToTopをemitベースに変更（DOM依存解消）
- ✅ sortDisplayOrderForOfficialに詳細コメント追加

#### ドキュメント
- ✅ docs/usage/index.md更新（デッキ編集画面追加）
- ✅ docs/research/i18n-investigation.md（多言語調査）
- ✅ docs/dev/privacy-policy.md

#### リリース
- ✅ PR#2作成・レビュー対応・マージ
- ✅ devブランチにマージ完了
- ✅ バージョン 0.2.1 → 0.2.2（開発版）

---

## 2025-11-10 (16:51): tmp/prototype DeckCard リファクタリング

### 実施内容

1. **emit経由からstore直接呼び出しへの変更**:
   - DeckCard.vueに`useDeckStore`をインポート
   - カード移動・追加ボタンのハンドラーを直接storeメソッド呼び出しに変更
   - 不要なemitを削除（dragstart, drop, clickのみ残す）

2. **ボタンハンドラーの修正**:
   - `handleTopRight()`: side → main/extra移動、main/extra → side移動
   - `handleBottomLeft()`: trash → main/extra移動、search → 追加、その他 → trash移動
   - `handleBottomRight()`: trash → side移動、search → side追加、その他 → コピー追加

3. **引数順序の修正**:
   - emit時の余分な`sectionType`引数を削除
   - card, indexのみを渡すように統一

### 技術詳細

**変更前**:
```javascript
handleTopRight() {
  this.$emit('move-to-side', this.card, this.index, this.sectionType)
}
```

**変更後**:
```javascript
handleTopRight() {
  if (this.sectionType === 'side') {
    this.deckStore.moveCardFromSide(this.card)
  } else if (this.sectionType === 'main' || this.sectionType === 'extra') {
    this.deckStore.moveCardToSide(this.card, this.sectionType)
  }
}
```

### 成果

- コードの簡潔化
- データフローの明確化
- 親コンポーネントでのイベントハンドラー削減

---

## 2025-11-10 (14:49): 効果タイプ判定を画像ベースに変更

### 実施内容

1. **文字列判定から画像ベース判定への変更**:
   - `SPELL_EFFECT_PATH_TO_ID`と`TRAP_EFFECT_PATH_TO_ID`マップを追加
   - `effect_icon_*.png`のファイル名から効果タイプを判定
   - 文字列ベースの`SPELL_EFFECT_TYPE_TEXT_TO_ID`使用を廃止

2. **3箇所の修正**:
   - `getCardDetail()`: カード詳細ページのパース
   - `parseSpellCard()`: 魔法カード検索結果のパース
   - `parseTrapCard()`: 罠カード検索結果のパース

3. **Geminiレビューコメントへの追記**:
   - 当初の文字列判定は言語依存であったことを説明
   - 画像ベースの判定に改善したことを報告

### 技術詳細

**画像ベースの判定ロジック**:
```typescript
// box_card_effectのimg要素から効果タイプを抽出
const effectImg = doc.querySelector('.box_card_effect .icon_img[src*="effect_icon"]') as HTMLImageElement;
if (effectImg?.src) {
  const match = effectImg.src.match(/effect_icon_([^.]+)\.png/);
  if (match && match[1]) {
    spellEffectType = SPELL_EFFECT_PATH_TO_ID[match[1]];
    // 例: 'effect_icon_quickplay.png' → 'quickplay' → 'quick'
  }
}
```

**マッピング例**:
- 魔法: `quickplay` → `quick`, `continuous` → `continuous`, `field` → `field`
- 罠: `counter` → `counter`, `continuous` → `continuous`

### 成果物

- 言語非依存で堅牢な効果タイプ判定
- コミット: 78b935e "fix: 魔法・罠の効果タイプ判定を文字列から画像ベースに変更"

---

## 2025-11-10 (13:55): Geminiレビュー対応と設定制御機能の追加

### 実施内容

1. **Geminiレビューコメントへの対応（PR #1）**:
   - 高優先度: `endsWith('spell')` → `endsWith('魔法')` 修正
   - 高優先度: `endsWith('trap')` → `endsWith('罠')` 修正
   - 高優先度: tsconfig.jsonで型安全性を再度有効化、webpack.config.jsでVueファイルのみ無効化
   - 中優先度: console.error文を再追加してエラーログを復活
   - 各コメントに個別に返信して解決

2. **オプションページによる機能制御の実装**:
   - `src/types/settings.ts`: 設定の型定義
   - `src/utils/settings.ts`: 設定読み込みユーティリティ
   - `src/content/index.ts`: 設定に基づいて機能を条件付きで初期化

3. **変更内容のコミット・プッシュ**:
   - コミット: a032149 "feat: オプションページで機能の有効/無効を制御可能に"
   - ブランチ: feature/deck-recipe-image

### 技術詳細

**型安全性のバランス調整**:
- `tsconfig.json`では全体的に`noImplicitAny: true`と`noUnusedParameters: true`を維持
- `webpack.config.js`のts-loaderで`.vue`ファイルのみこれらを無効化
- 通常のTypeScriptファイル：厳格な型チェック
- Vueファイル：フレームワーク特有の制約に対応

**設定制御の仕組み**:
```typescript
// options.htmlで設定を保存
chrome.storage.local.set({ featureSettings: { 'shuffle-sort': true, 'deck-image': false } })

// content scriptで設定を読み込み
const settings = await loadFeatureSettings();
if (settings['deck-image']) {
  initDeckImageButton();
}
```

### 成果物

- PR #1のレビュー完全対応
- ユーザーが各機能のON/OFFを切り替え可能に
- 型安全性とVue互換性のバランスを実現

---

## 2025-11-09 (23:00): 動画撮影スクリプトの作成と実行

### 実施内容

1. **動画撮影用のスクリプトを作成**:
   - Chrome DevTools Protocol (CDP)を使用した動画撮影
   - ffmpegで動画作成、GIF変換（パレット最適化）
   - 適切なクロッピングと容量管理

2. **作成したスクリプト**:
   - `video-helper.js`: 動画撮影用CDPヘルパー
     - recordVideo() - MP4動画撮影（領域指定、FPS指定）
     - getElementClip() - 要素領域の取得
     - convertToGif() - MP4からGIFへ変換（パレット最適化）
   - `record-shuffle-sort.js`: シャッフル・ソート動画撮影
     - メインデッキ領域のみをクロッピング
     - 1.5秒間の動画撮影（30fps → 15fps GIF）
   - `record-dialog.js`: ダイアログ動画撮影
     - 開閉アニメーション（3秒）
     - 背景色切り替え（3.5秒）
   - `record-all-videos.js`: 全動画一括撮影
   - `README.md`: 動画撮影スクリプトの説明を追加

3. **撮影した動画とGIF**:
   - 合計4本の動画（MP4）と4個のアニメーションGIF

### 作成したメディア

**動画（MP4）**:
- shuffle-animation.mp4 (182KB) - シャッフル動作
- sort-animation.mp4 (188KB) - ソート動作
- dialog-open-close.mp4 (356KB) - ダイアログ開閉
- dialog-color-change.mp4 (44KB) - 背景色切り替え

**アニメーションGIF**:
- shuffle-animation.gif (441KB) - 15fps, 800px幅, 128色
- sort-animation.gif (447KB) - 15fps, 800px幅, 128色
- dialog-open-close.gif (339KB) - 15fps, 800px幅, 128色
- dialog-color-change.gif (179KB) - 15fps, 元サイズ, 128色

### 技術詳細

**動画撮影**:
- CDPの `Page.captureScreenshot` を連続呼び出し（30fps）
- 領域指定（clip）でクロッピング
- ffmpegで連続PNGフレームからMP4作成

**GIF変換**:
- パレット生成（palettegen）で高品質GIF
- フレームレート調整（30fps → 15fps）
- 色数制限（128色）で容量削減
- 必要に応じてリサイズ（scale filter）

**容量管理**:
- libx264のため、幅と高さを偶数に自動調整
- GIFはすべて500KB以下に最適化

### 変更ファイル

- `scripts/screenshots/usage/video-helper.js`: 新規作成
- `scripts/screenshots/usage/record-shuffle-sort.js`: 新規作成
- `scripts/screenshots/usage/record-dialog.js`: 新規作成
- `scripts/screenshots/usage/record-all-videos.js`: 新規作成
- `scripts/screenshots/usage/README.md`: 動画撮影の説明を追加
- `docs/usage/images/*.mp4`: 4本の動画
- `docs/usage/images/*.gif`: 4個のアニメーションGIF

### 次のステップ

- docs/usage/index.mdにGIFを埋め込む
- 必要に応じて動画の長さやFPSを調整

## 2025-11-09 (22:30): アニメーション改善（FLIP technique + クローズアニメーション）

### 実施内容

1. **シャッフル・ソートにFLIP techniqueを実装**:
   - カードの位置変化を滑らかにアニメーション
   - First: シャッフル前の各カードの位置を記録
   - Last: DOM操作後の新しい位置を記録
   - Invert: transformで元の位置に戻す
   - Play: transformを0にしてアニメーション
   - これにより、カードが実際に移動する様子が視覚的に見えるようになった

2. **ダイアログのクローズアニメーションを実装**:
   - フェードアウト + スライドアップアニメーション追加
   - 開くとき: フェードイン + スライドダウン
   - 閉じるとき: フェードアウト + スライドアップ
   - オーバーレイクリック時とダウンロード完了時の両方に適用

### 技術詳細

**FLIP technique**:
- `applyFlipAnimation()` 関数を作成
- `getBoundingClientRect()` で位置を記録
- `transform: translate()` で一時的に元の位置に戻す
- `requestAnimationFrame()` でアニメーション開始
- `cubic-bezier(0.4, 0.0, 0.2, 1)` イージング適用

**クローズアニメーション**:
- `@keyframes ygo-popup-out` - ポップアップのフェードアウト
- `@keyframes ygo-overlay-out` - オーバーレイのフェードアウト
- `closePopup()` 関数で再利用可能に

### 変更ファイル

- `src/content/shuffle/shuffleCards.ts`: FLIP techniqueでアニメーション追加
- `src/content/deck-recipe/imageDialog.ts`: クローズアニメーション追加

### 効果

- シャッフル・ソート時にカードが移動する様子が見える
- ダイアログの開閉がよりスムーズで自然に

## 2025-11-09 (22:00): スクリーンショット撮影スクリプトの作成と実行

### 実施内容

1. **scripts/screenshots/usage/にスクリーンショット撮影スクリプトを作成**:
   - Chrome DevTools Protocol (CDP)を使用した自動スクリーンショット撮影
   - docs/usage/ドキュメント用の画像を自動生成

2. **作成したスクリプト**:
   - `screenshot-helper.js`: スクリーンショット撮影用CDPヘルパー
     - captureFullPage(), captureViewport(), captureElement(), captureClip()
   - `capture-deck-page.js`: デッキ表示ページのスクリーンショット撮影（5枚）
     - ページ全体、シャッフル・ソートボタン、デッキ画像作成ボタン
     - カードロック機能、ロックされたカード
   - `capture-dialog.js`: ダイアログのスクリーンショット撮影（7枚）
     - ダイアログ全体、デッキ名入力、赤背景、青背景
     - QRトグルON/OFF、ダウンロードボタン
   - `capture-all.js`: 全スクリーンショット一括撮影
   - `process-images.js`: 画像加工スクリプト（ImageMagick使用）
     - addBorder(), addArrow(), addText(), addRectangle(), resize()
   - `README.md`: スクリプトの使い方説明

3. **スクリーンショット撮影実行**:
   - 合計12枚のスクリーンショットを撮影
   - すべて docs/usage/images/ に保存

### 撮影した画像

**デッキ表示ページ（5枚）**:
1. deck-display-page-overview.png (3.9MB) - ページ全体
2. shuffle-sort-buttons.png (18KB) - シャッフル・ソートボタン
3. deck-image-button.png (7.9KB) - デッキ画像作成ボタン
4. card-lock-feature.png (29KB) - カードロック機能
5. card-locked-state.png (29KB) - ロックされたカード

**ダイアログ（7枚）**:
6. image-dialog-overview.png (132KB) - ダイアログ全体
7. image-dialog-deck-name.png (2.1KB) - デッキ名入力欄
8. image-dialog-color-red.png (105KB) - 赤背景プレビュー
9. image-dialog-color-blue.png (109KB) - 青背景プレビュー
10. image-dialog-qr-on.png (5.3KB) - QRトグルON
11. image-dialog-qr-off.png (6.0KB) - QRトグルOFF
12. image-dialog-download-button.png (5.6KB) - ダウンロードボタン

### 変更ファイル

- `scripts/screenshots/usage/screenshot-helper.js`: 新規作成
- `scripts/screenshots/usage/capture-deck-page.js`: 新規作成
- `scripts/screenshots/usage/capture-dialog.js`: 新規作成
- `scripts/screenshots/usage/capture-all.js`: 新規作成
- `scripts/screenshots/usage/process-images.js`: 新規作成
- `scripts/screenshots/usage/README.md`: 新規作成
- `docs/usage/images/*.png`: 12枚のスクリーンショット

### 次のステップ

- docs/usage/index.mdに画像を埋め込む
- 必要に応じて画像加工（枠線、注釈など）

## 2025-11-09 (21:30): ブラウザテストスイートの作成

### 実施内容

1. **tests/browser/ディレクトリにブラウザテストスイートを作成**:
   - Chrome DevTools Protocol (CDP)を使用した自動テスト
   - Chromiumブラウザ上で拡張機能の動作を確認

2. **作成したテストファイル**:
   - `cdp-helper.js`: CDP共通ヘルパー関数
     - connectCDP(), evaluate(), navigate(), wait(), close()
   - `test-buttons.js`: ボタン表示確認テスト
     - シャッフル、ソート、デッキ画像作成ボタンの存在確認
     - カメラアイコンのSVG塗りつぶしなし確認 (fill: none)
   - `test-shuffle.js`: シャッフル・ソート機能テスト
     - カード順序の変更確認
     - 元の順序への復元確認
     - アニメーションクラス適用確認
   - `test-lock.js`: Lock機能（sortfix）テスト
     - 右上1/4エリアクリックでロック
     - 視覚的フィードバック確認（背景色、南京錠アイコン）
     - デッキ先頭への移動確認
     - シャッフル時の順序保持確認
     - ロック解除確認
   - `test-dialog.js`: デッキ画像作成ダイアログテスト
     - ダイアログ表示確認
     - デッキ名入力フィールド確認
     - 背景色切り替え確認（赤↔青）
     - QRトグルボタン確認
     - ダウンロードボタン確認
     - ダイアログクローズ確認
   - `README.md`: テストスイートの説明書
     - 前提条件（Chromium起動方法）
     - 各テストファイルの説明
     - 実行方法
     - トラブルシューティング

### 技術詳細

- WebSocket経由でChrome DevTools Protocolを使用
- `.chrome_playwright_ws`からWebSocket URLを読み込み
- `Runtime.evaluate`でJavaScriptコード実行
- `Page.navigate`でページ遷移
- 公開デッキURLでテスト実行（認証不要）

### 変更ファイル

- `tests/browser/cdp-helper.js`: 新規作成
- `tests/browser/test-buttons.js`: 新規作成
- `tests/browser/test-shuffle.js`: 新規作成
- `tests/browser/test-lock.js`: 新規作成
- `tests/browser/test-dialog.js`: 新規作成
- `tests/browser/README.md`: 新規作成

### 次のステップ

- 実際にテストを実行して動作確認
- 必要に応じてテストケースを追加

## 2025-11-09 (20:10): 動作確認完了と画像配置計画の作成

### 実施内容

1. **tests/sample/url.mdの正しいURLで動作確認**:
   - CLAUDE.mdに従い、tests/sample/url.mdに記載された公開デッキURLを使用
   - Chrome CDP経由で動作確認を実施
   - ✅ シャッフルボタン: 存在
   - ✅ ソートボタン: 存在
   - ✅ デッキ画像作成ボタン: 存在
   - ✅ カメラアイコンの塗りつぶしなし（fill: none）- 修正が正しく機能

2. **docs/usage/images/に画像配置計画を記載**:
   - docs/usage/images/README.mdを作成
   - 12枚の画像配置を計画:
     - デッキ表示ページ関連: 5枚（全体、ボタン、ロック機能）
     - デッキ画像作成ダイアログ関連: 7枚（全体、各オプション、ボタン）
   - 各画像の内容、撮影位置、目的、参照URLを明記
   - 全てtests/sample/url.mdのURLを参照するように記載

### 反省点

- 当初、tests/sample/url.mdを無視して適当なURLを使用していた
- CLAUDE.mdに明記されているルールに従わなかった
- 今後は必ずtests/sample/を参照する

### 変更ファイル

- `docs/usage/images/README.md`: 画像配置計画を新規作成

### 次のステップ

- 画像の実際の撮影（Chrome CDPでスクリーンショット取得）
- docs/usage/index.mdに画像を埋め込む

## 2025-11-09 (19:50): カメラアイコンの塗りつぶし問題を修正

### 実施内容

1. **問題の特定**:
   - デッキ表示ページでカメラアイコンが塗りつぶされていた
   - デッキ編集ページでは正しく表示されていた（輪郭のみ）
   - 原因: CSSで `fill` と `stroke` が明示的に指定されていなかった

2. **修正内容**:
   - `src/content/styles/buttons.css` を修正
   - `.ytomo-neuron-btn svg` に以下を追加:
     - `fill: none !important;`
     - `stroke: currentColor !important;`

3. **ビルドとデプロイ**:
   - ビルド成功
   - デプロイ完了

### 変更理由

ユーザー指摘：
- デッキ表示ページだけカメラアイコンが塗りつぶされている

### 変更ファイル

- `src/content/styles/buttons.css`: SVGスタイルを明示的に指定

### 効果

- デッキ表示ページでもカメラアイコンが正しく表示される（輪郭のみ、塗りつぶしなし）
- ページ固有のCSSによる影響を防止

## 2025-11-09 (19:45): デッキ編集ページでのボタン表示を無効化

### 実施内容

1. **isDeckPage()の修正**:
   - デッキ表示ページ（ope=1）のみでtrueを返すように変更
   - デッキ編集ページ（ope=2）ではfalseを返すように修正
   - 正規表現: `/member_deck\.action\?.*ope=[12]/` → `/member_deck\.action\?.*ope=1/`

2. **ドキュメントの修正**:
   - デッキ編集ページのセクションを大幅に簡略化
   - 「現在この拡張機能による追加機能はありません」と明記
   - デッキ画像作成機能の詳細説明を削除

3. **ビルドとデプロイ**:
   - ビルド成功
   - デプロイ完了

### 変更理由

ユーザー指摘：
- デッキ編集ページでは画像作成機能が動作しない
- 機能しないのにボタンを配置すべきではない

### 変更ファイル

- `src/content/deck-recipe/addImageButton.ts`: isDeckPage()の判定条件を修正
- `docs/usage/index.md`: デッキ編集ページのセクションを簡略化

### 効果

- デッキ編集ページではデッキ画像作成ボタンが表示されなくなる
- ユーザーが機能しないボタンをクリックして混乱することを防止
- ドキュメントと実装が一致

## 2025-11-09 (19:30): 使い方ドキュメントの修正完了（lock機能追加、ダイアログ詳細化）

### 実施内容

1. **カードシャッフル機能にlock機能（sortfix）を追加**:
   - カード右上1/4のエリアをクリックでロック/ロック解除
   - ロックされたカードは先頭に固定され、シャッフルの影響を受けない
   - 視覚的なインジケーター（薄い青緑背景、南京錠アイコン）の説明
   - 複数カードのロック時の挙動を記載

2. **デッキ画像作成ダイアログの説明を詳細化**:
   - 「オプション（設定項目）」と「ボタン」に明確に分離
   - デッキ名入力欄、背景色選択、プレビュー画像をオプションとして整理
   - QRトグルボタン、ダウンロードボタン、閉じるボタンを明記
   - ダウンロード時のスピナーアイコン表示についても記載

3. **デッキ編集ページの機能状況を明記**:
   - デッキ画像作成機能が現在動作しないことを警告表示
   - デッキ表示ページ（ope=1）でのみ利用可能であることを明記
   - 将来的に対応予定であることを記載

### 修正内容の詳細

**カードシャッフル機能**:
- lock機能の使い方（右上1/4クリック）
- ロック時の視覚的フィードバック
- シャッフル時の挙動（ロックカードは先頭固定）
- ソート時もロック状態が維持されることを明記

**デッキ画像作成ダイアログ**:
- オプション3項目（デッキ名、背景色、プレビュー）
- ボタン3種類（QRトグル、ダウンロード、閉じる）
- 各項目の位置、機能、使い方を詳細に記載

**デッキ編集ページ**:
- ⚠️ 警告マークで未実装を明示
- 現状の動作と将来的な対応予定を記載

### メリット

1. **完全性**: すべての機能（lock含む）が記載されている
2. **明確性**: オプションとボタンが明確に区別されている
3. **正確性**: 動作しない機能を明確に記載し、誤解を防止
4. **実用性**: ユーザーが実際に使える機能だけを強調

## 2025-11-09 (19:15): 使い方ドキュメントの作成完了（機能を集団単位で整理）

### 実施内容

1. **docs/usage/ ディレクトリの作成**:
   - ユーザー向けの使い方ドキュメント用ディレクトリを新規作成

2. **使い方ドキュメント（index.md）の作成**:
   - ページ→機能→ボタンの順に分類して記載
   - 機能を集団単位で整理（個別のボタンではなく、関連する機能をまとめる）

3. **記載内容（機能を集団で整理）**:
   - **デッキ表示ページ（member_deck.action?ope=1）**:
     - **カードシャッフル機能**（シャッフルボタン + ソートボタン）
     - **デッキ画像作成機能**（カメラアイコンボタン）
   - **デッキ編集ページ（member_deck.action?ope=2）**:
     - **デッキ画像作成機能**（カメラアイコンボタン）
   - **デッキ画像作成ダイアログ**:
     - デッキ名入力欄
     - プレビュー画像（クリックで赤/青切り替え）
     - QRトグルボタン（ON/OFF切り替え）
     - ダウンロードボタン
     - ダイアログを閉じる方法

4. **機能単位の整理**:
   - シャッフルとソートを別々の機能ではなく、一つの「カードシャッフル機能」として統合
   - 各機能の中に複数のボタンが含まれる構造に変更
   - ユーザーが機能の目的を理解しやすいように集団で整理

5. **操作フロー例の追加**:
   - デッキ画像を作成してダウンロードする手順
   - デッキをシャッフルする手順（シャッフルと元に戻すを含む）

6. **注意事項とトラブルシューティングの追加**:
   - 対象ページの説明
   - ログイン要件
   - よくある問題と解決方法

### 技術的詳細

- **ドキュメントファイル**: `docs/usage/index.md`
- **参照したファイル**:
  - `src/content/index.ts`: エントリーポイント
  - `src/content/deck-recipe/addImageButton.ts`: デッキ画像作成ボタン
  - `src/content/shuffle/addShuffleButtons.ts`: シャッフル・ソートボタン
  - `src/content/deck-recipe/imageDialog.ts`: ダイアログUI

### メリット

1. **ユーザーフレンドリー**: 機能の目的が明確で、初めてのユーザーでも理解しやすい
2. **構造化**: ページ→機能→ボタンの順で整理され、探しやすい
3. **実用的**: 操作フロー例で実際の使い方がイメージできる
4. **保守性**: testページを除外し、実際のユーザー向け機能のみを記載
5. **集団整理**: 関連するボタンを機能単位でまとめ、理解しやすい構造

## 2025-11-09 (18:30): シャッフル機能の調査完了

### 実施内容

1. **デッキ表示ページのDOM構造調査**:
   - 公開デッキページ（dno=95）のHTMLをダウンロード
   - Chrome CDP経由でJavaScript実行後のDOM構造を確認
   - メインデッキ、エクストラデッキ、サイドデッキの構造を特定

2. **ボタン配置位置の決定**:
   - 候補1: `div.subcatergory > div.top` の最後（カード枚数の後）
   - 候補2: `div.subcatergory` の直後に独立したdivを追加
   - **決定**: 候補1を採用（視覚的に分かりやすく、既存レイアウトを崩さない）

3. **カード一覧の構造解析**:
   - メインデッキは3カテゴリに分割（モンスター/魔法/罠）
   - 各カテゴリは `.t_body` 要素内に `.t_row` 要素が配置
   - モンスター: `.t_body.mlist_m`（13行/27枚）
   - 魔法: `.t_body.mlist_s`（6行/9枚）
   - 罠: `.t_body.mlist_t`（3行/5枚）

4. **シャッフル実装方針の確定**:
   - 各 `.t_body` 内の `.t_row` 要素の順序を変更
   - 複数枚のカードは1行にまとめられているため、行単位でシャッフル
   - 元の順序を保存してソート機能で復元

5. **flip and shuffle機能の設計**:
   - カードバック画像は拡張機能側で用意（ページ内に存在しない）
   - `img.src` を書き換えて裏面表示
   - `dataset.originalSrc` に元のURLを保存
   - クリックイベントで表面に戻す

### 技術的詳細

- **調査対象URL**: 公開デッキ表示ページ（dno=95）
- **調査スクリプト**: `tmp/browser/investigate-shuffle-v3.js`
- **サンプルHTML**: `tmp/deck-display-page.html`
- **調査ドキュメント**: `docs/research/shuffle-feature-investigation.md`

### 次のステップ

- テストHTML作成（サンプルページ）
- ボタン追加機能の実装（TDD）
- シャッフル/ソート/flip and shuffle機能の実装

## 2025-11-09 (15:00): デッキ画像作成ダイアログUI完成

### 実施内容

1. **HTMLエスケープ問題の修正**:
   - `src/api/card-search.ts`の`extractImageInfo`関数で`&amp;`に対応
   - 正規表現を修正: `(?:&(?:amp;)?ciid=` および `(?:&(?:amp;)?enc=`
   - これにより全カード画像が正しく表示されるようになった

2. **ダイアログレイアウトの調整**:
   - 余白を縮小: topMargin 80px→40px、padding 20px→12px
   - タイトル入力欄を中央揃えに変更（`left: 50%; transform: translateX(-50%);`）
   - ボタンをデッキ画像の内側に配置（`#ygo-background-image`の子要素に移動）
   - 背景色を調整: `#ffffff`→`#d8d8d8`（薄いグレー）

3. **QRボタンの視覚改善**:
   - ON時: 明るい青背景（`rgba(120, 150, 255, 0.7)`）、白テキスト
   - OFF時: グレー背景（`rgba(150, 150, 150, 0.1)`）、opacity 0.7

4. **ダウンロードボタンの処理中アニメーション**:
   - クリック時にアイコンを回転スピナーに置き換え
   - ボタンを無効化（`disabled`）して二重クリック防止
   - 処理完了後にダイアログを自動的に閉じる
   - エラー時はボタンを元の状態に戻す

### 技術的詳細

- **ファイル**: `src/content/deck-recipe/imageDialog.ts`
- **スピナーアニメーション**: CSS `@keyframes ygo-spinner-rotate`で360度回転
- **状態管理**: `disabled`属性と`innerHTML`の動的変更

### 動作確認

- ✅ ダイアログ表示確認
- ✅ レイアウト調整確認（余白、中央揃え、背景色）
- ✅ QRボタンON/OFF状態の視覚確認
- ✅ ダウンロード処理中のスピナーアニメーション確認

## 2025-11-09 (03:30): UI改善とポップアップ実装

### 実施内容

1. **不要な表示の削除**:
   - 右上に常時表示されていた「Yu-Gi-Oh! Extension Loaded!」のデバッグ表示を削除
   - `src/content/test-ui/index.ts` から該当コード（18-28行目）を削除

2. **ポップアップUI実装**:
   - `src/popup/index.ts` を実装
   - 拡張機能アイコンクリック → 「テストページを開く」ボタン表示
   - ボタンクリックで新しいタブでテストページが開く

3. **動作確認**:
   - ビルド成功確認
   - デプロイ完了

### 変更理由

デバッグ表示が本番環境で不要であり、ユーザー体験を損なうため削除。また、拡張機能アイコンから直接テストページを開けるようにしました。

## 2025-11-09 (03:10): CardType型を英語識別子に統一

### 実施内容

1. **型定義の変更**:
   - `CardType`を日本語文字列（'モンスター' | '魔法' | '罠'）から英語識別子（'monster' | 'spell' | 'trap'）に変更
   - `src/types/card-maps.ts`に`CARD_TYPE_MAP`と`CARD_TYPE_TEXT_TO_ID`を追加
   - `src/types/card.ts`のインターフェース定義（MonsterCard, SpellCard, TrapCard）を更新

2. **全ファイルの一括修正**:
   - `src/api/card-search.ts`: パーサー内のCardType使用箇所を修正
   - `src/api/deck-operations.ts`: CardType使用箇所を修正
   - `src/content/card/detector.ts`: CardType使用箇所を修正
   - `src/content/parser/deck-parser.ts`: CardType使用箇所を修正
   - `src/content/test-ui/index.ts`: CardType使用箇所を修正
   - 全テストファイル（`__tests__/`）のCardType literalを修正

3. **動作確認**:
   - ビルド成功確認（TypeScriptエラー0件）
   - `tests/combine/parser/`内の全テストを実行して成功確認
     - card-detail-page.test.ts ✓
     - card-search.test.ts ✓
     - deck-detail.test.ts ✓
     - card-detail.test.ts ✓
     - card-faq-list.test.ts ✓
     - faq-detail.test.ts ✓

### 変更理由

言語依存の文字列リテラルを型定義に使用していたため、コードの保守性と拡張性に問題がありました。英語識別子に統一することで、将来的な多言語対応や型安全性の向上を実現しました。

## 2025-11-09 (06:00): 未実装パーサーの実装完了

### 実施内容

1. **カード詳細パーサーの実装** (`src/api/card-search.ts`):
   - `parsePackInfo()`: 収録シリーズ情報の抽出
     - 発売日、カード番号、パック名を取得
   - `parseRelatedCards()`: 関連カード情報の抽出
     - #card_list または .list_style.list から .t_row を抽出
     - parseSearchResultRow を再利用
   - `getCardDetail()`: TODOコメント削除、実装完了

2. **カードQA一覧パーサーの実装** (`src/api/card-faq.ts`):
   - `getCardFAQList()`: HTMLパース処理の実装
     - タイトルからカード名を抽出
     - .t_row から FAQ ID、質問文、更新日を抽出
     - スタブ実装から完全実装に変更

3. **個別QA詳細パーサーの実装** (`src/api/card-faq.ts`):
   - `getFAQDetail()`: HTMLパース処理の実装
     - #question_text から質問文を抽出
     - #answer_text から回答を抽出
     - 更新日を抽出
     - スタブ実装から完全実装に変更

4. **テストファイルの作成と実行**:
   - `card-detail.test.ts`: ✓ 成功（2 packs, 10 related cards）
   - `card-faq-list.test.ts`: ✓ 成功（3 FAQs）
   - `faq-detail.test.ts`: ✓ 成功（質問115文字、回答89文字）

5. **README更新**:
   - 実装済みパーサーの情報を追加
   - 全テスト実行コマンドを更新

### 検証結果

全てのパーサーが正常に動作することを確認：
- カード詳細パーサー: ✓ 正常動作
- カードQA一覧パーサー: ✓ 正常動作
- 個別QA詳細パーサー: ✓ 正常動作

### intro.md要件の充足

intro.mdに記載された全ての基本機能のパーサーが実装完了しました：
- ✅ デッキ個別取得
- ✅ デッキ一覧取得
- ✅ カード検索
- ✅ カード詳細情報（収録シリーズ・関連カード）
- ✅ カードQA一覧取得
- ✅ 個別QA詳細取得

## 2025-11-09 (05:00): パーサー動作確認テスト作成完了

### 実施内容

1. **tests/combine/parser/ディレクトリの作成**:
   - パーサーテスト用のディレクトリを新規作成

2. **実装済みパーサーのテストファイル作成**:
   - `deck-detail.test.ts` - デッキ詳細パーサーのテスト
     - parseDeckDetail関数の動作確認
     - 結果: ✓ 成功（26 mainDeck, 14 extraDeck, 0 sideDeck）
   - `card-search.test.ts` - カード検索結果パーサーのテスト
     - parseSearchResultRow + extractImageInfo関数の動作確認
     - 結果: ✓ 成功（10枚のモンスターカードをパース）

3. **カード検索結果HTMLの再取得**:
   - 当初のHTMLが検索フォームページだったため、実際の検索結果ページを再取得
   - キーワード: ブラック・マジシャン
   - サイズ: 214KB → 285KB

4. **README.md作成**:
   - テストの実行方法と対象ファイルの説明を記載
   - 未実装パーサー（card-detail, card-faq-list, faq-detail）の情報も記載

### 検証結果

全ての実装済みパーサーが正常に動作することを確認：
- デッキ詳細パーサー: ✓ 正常動作
- カード検索結果パーサー: ✓ 正常動作

### 実行方法

```bash
npx tsx tests/combine/parser/deck-detail.test.ts
npx tsx tests/combine/parser/card-search.test.ts
```

## 2025-11-09 (04:15): テストデータHTML取得完了

### 実施内容

1. **tests/combine/data/ディレクトリの作成**:
   - テストデータ用のディレクトリを新規作成

2. **intro.mdに記載されたURLでHTMLファイルを取得**:
   - `deck-detail-public.html` (432KB) - デッキレシピ詳細ページ
   - `card-search-result.html` (214KB) - カード検索結果ページ（ope=1）
   - `card-detail.html` (308KB) - カード詳細ページ（ope=2, cid=12976）
   - `card-faq-list.html` (210KB) - カードQA一覧ページ（faq_search.action ope=4, cid=5533）
   - `faq-detail.html` (209KB) - 個別QAページ（faq_search.action ope=5, fid=115）

3. **エンドポイント修正**:
   - 当初、カードQA関連で`card_search.action`を使用していたが、intro.mdの記載通り`faq_search.action`に修正
   - すべてのURLに`request_locale=ja`を追加

### 取得方法

- Chrome DevTools Protocol（CDP）経由でHTMLを取得
- `tmp/fetch-correct-html.js`スクリプトを作成して実行

## 2025-11-09 (03:30): DeckType/DeckStyleの内部値化

### 実施内容

1. **型定義の修正**:
   - `DeckType` → 表示名の型として維持
   - `DeckTypeValue` → 内部値（"0", "1", "2", "3"）の型として使用
   - `DeckStyle` → 表示名の型として維持
   - `DeckStyleValue` → 内部値（"0", "1", "2"）の型として使用

2. **マッピング定数の追加** (`src/types/deck-metadata.ts`):
   - `DECK_TYPE_LABEL_TO_VALUE`: 表示名→内部値の変換マップ
   - `DECK_STYLE_LABEL_TO_VALUE`: 表示名→内部値の変換マップ

3. **パーサーの修正**:
   - `extractDeckType()`: 表示名を取得後、内部値に変換して返却
   - `extractDeckStyle()`: 表示名を取得後、内部値に変換して返却
   - `parseDeckListRow()`: デッキ一覧でも同様の変換を実施

4. **DeckInfo/DeckListItem型の修正**:
   - `deckType`フィールド: `DeckType` → `DeckTypeValue`
   - `deckStyle`フィールド: `DeckStyle` → `DeckStyleValue`

### 変更理由

- ユーザーの指摘: 「なぜデッキタイプやデッキスタイルなどは種族や属性と違って文字列をそのまま扱うだけでいいんですか？」
- Race/Attributeと同じパターン（内部ID + マッピング）に統一

### バージョン

- 0.0.10 → 0.0.11（パッチ: バグ修正）

## 2025-11-09 (02:00): 新API動作確認完了（Phase 1）

### 実施内容

1. **ブラウザテスト環境準備**:
   - Chromium（CDP経由）でテストページにアクセス
   - `https://www.db.yugioh-card.com/yugiohdb/#/ytomo/test`
   - ページリロードが必要なことを確認

2. **全APIの動作確認**:
   - ✅ **getDeckDetail**: 正常動作（dno=4のデッキ情報を取得）
   - ✅ **getDeckList**: 正常動作（8個のデッキ一覧を取得）
   - ✅ **getCardDetail**: 動作確認（スタブ実装のためnull返却）
   - ✅ **getCardFAQList**: 動作確認（スタブ実装のため空配列返却）
   - ✅ **getFAQDetail**: 動作確認（スタブ実装のためTODOプレースホルダー返却）

3. **判明した事項**:
   - getCardDetailは`parseSearchResults`が検索結果ページの構造を想定しているため、カード詳細ページ（ope=2）では動作しない
   - スタブ実装の3機能は、後でパーサー実装が必要（Phase 1完了条件）

### Phase 1の状態

- ✅ テストページで全APIの動作確認
- 🔄 スタブ実装した3機能の詳細パーサー実装（次のタスク）
  - カード詳細情報（収録シリーズ・関連カード）
  - カードQA一覧
  - 個別QA詳細

## 2025-11-08 (23:30): テストページに新API追加（Phase 1）

### 実施内容

1. **テストページUI実装**:
   - `src/content/test-ui/index.ts`: 5つの新APIのテストセクションを追加
   - デッキ個別取得: dno入力、取得ボタン、結果表示
   - マイデッキ一覧取得: 取得ボタン（引数なし）、結果表示
   - カード詳細情報取得: cardId入力、取得ボタン、結果表示
   - カードQA一覧取得: cardId入力、取得ボタン、結果表示
   - 個別QA詳細取得: faqId入力、取得ボタン、結果表示

2. **ビルド・デプロイ**:
   - ✅ ビルド成功
   - ✅ デプロイ完了

### テスト方法

Chromiumで `https://www.db.yugioh-card.com/yugiohdb/#/ytomo/test` にアクセスして、各APIの動作を確認できます。

## 2025-11-08 (14:00): intro.mdで要求される基本API実装（Phase 1）

### 実施内容

1. **デッキ個別取得API実装**:
   - `src/api/deck-operations.ts`: `getDeckDetail(dno, cgid?)` 関数を追加
   - 既存の`parseDeckDetail`パーサーを活用
   - 公開デッキは cgid 省略可、非公開デッキは cgid 必須

2. **マイデッキ一覧取得API実装**:
   - `src/types/deck.ts`: `DeckListItem` 型定義を追加
   - `src/content/parser/deck-list-parser.ts`: デッキ一覧ページのパーサーを新規作成
   - `src/api/deck-operations.ts`: `getDeckListInternal(cgid)` 関数を追加
   - `src/content/session/session.ts`: `SessionManager.getDeckList()` メソッドを追加
   - Chrome CDPを使用してデッキ一覧ページ（ope=4）のHTML構造を調査

3. **カード詳細情報型定義とAPI実装**:
   - `src/types/card.ts`: `PackInfo`（収録シリーズ）、`CardDetail`、`CardFAQ`、`CardFAQList` 型を追加
   - `src/api/card-search.ts`: `getCardDetail(cardId)` 関数を追加（スタブ実装）
   - 収録シリーズ、関連カードを含む拡張情報の型定義

4. **カードQA関連API実装**:
   - `src/api/card-faq.ts`: 新規ファイル作成
   - `getCardFAQList(cardId)`: カードQA一覧取得（スタブ実装）
   - `getFAQDetail(faqId)`: 個別QA詳細取得（スタブ実装）

### 実装状況

intro.mdで要求されるすべての基本機能のAPI枠組みが実装完了：

✅ **完全実装**:
- cgid取得
- デッキ新規作成
- デッキ複製
- デッキ上書き保存
- デッキ削除
- デッキ個別取得
- マイデッキ一覧取得
- カード検索

📝 **スタブ実装**（詳細パーサーは後で実装予定）:
- カード詳細情報取得（収録シリーズ・関連カード）
- カードQA一覧取得
- 個別QA詳細取得

## 2025-11-08 (午前): デッキメタデータの型定義追加と動的管理システム実装

### 実施内容

1. **デバッグログの削除**:
   - `src/api/card-search.ts`: 全てのconsole.*文を削除
   - `src/content/parser/deck-detail-parser.ts`: 全てのconsole.*文を削除
   - JSON出力がクリーンになり、パース結果が正しく利用可能に

2. **デッキメタデータの型定義追加**:
   - `src/types/deck-metadata.ts`: デッキタイプ、デッキスタイル、カテゴリの型定義
   - デッキ検索フォームから実際の選択肢を取得
   - DeckType: 'OCG（マスタールール）' | 'OCG（スピードルール）' | 'デュエルリンクス' | 'マスターデュエル' | string
   - DeckStyle: 'キャラクター' | 'トーナメント' | 'コンセプト' | string
   - DeckCategory: string[]（カテゴリID配列）

3. **デッキメタデータの動的管理システム実装**:
   - `scripts/update-deck-metadata.mjs`: デッキ検索ページからメタデータを取得してJSONを生成
   - `src/data/deck-metadata.json`: 初期メタデータ（443カテゴリ、4デッキタイプ、3デッキスタイル）
   - `src/utils/deck-metadata-loader.ts`: chrome.storage.localを優先的に読み込むローダー
   - `src/background/main.ts`: 24時間ごとに自動更新
   - ビルド時は初期JSONをバンドル、実行時はストレージから最新データを優先取得

4. **ビルドエラー修正**:
   - `tsconfig.json`: テストファイルを除外、jest型定義を削除
   - `src/types/qrcode.d.ts`: qrcodeモジュールの型定義を追加
   - `src/content/parser/deck-parser.ts`: deckTypeをstring型に修正
   - `scripts/deploy.sh`: distディレクトリパスを修正（extension/dist → dist）

### 変更ファイル
- `src/api/card-search.ts`
- `src/content/parser/deck-detail-parser.ts`
- `src/content/parser/deck-parser.ts`
- `src/types/deck-metadata.ts`
- `src/types/deck.ts`
- `src/types/qrcode.d.ts` (新規)
- `src/utils/deck-metadata-loader.ts` (新規)
- `src/data/deck-metadata.json` (新規)
- `src/background/main.ts`
- `scripts/update-deck-metadata.mjs` (新規)
- `scripts/deploy.sh`
- `tsconfig.json`
- `version.dat` (0.0.8 → 0.0.9)

### 動作確認
- ビルド成功
- パーサーテスト成功（tmp/parse-result-ja.json）
- デッキタイプ、デッキスタイル、コメントが正しく抽出されることを確認
- デプロイ成功

### 備考
カテゴリなどのメタデータが公式サイトで追加されても、拡張機能が自動的に24時間以内に最新情報を取得して更新する。

## 2025-11-08 01:47: buildCardImageUrlのundefined対策とエラーハンドリング改善（動作未確認）

### 実装内容

#### 問題点
1. **画像URLがundefinedになる問題**:
   - ユーザー報告: `"Failed to load image from undefined"`
   - `buildCardImageUrl`が`undefined`を返す場合がある
   - `loadImage(undefined)`が呼ばれてエラーになる

2. **エラーメッセージが不明瞭**:
   - `img.onerror`でEventオブジェクトをそのまま出力
   - `"[object Event]"`と表示されて原因不明

3. **CLAUDE.mdの誤記**:
   - 「普通のGoogle Chrome」と記載（実際は`chromium-browser`）

#### 実施した修正
1. **buildCardImageUrlのundefined対策**:
   - `createDeckRecipeImage.ts`でURLがundefinedの場合はスキップ
   - `url ? Array(quantity).fill(url) : []`に変更

2. **loadImage関数のエラーハンドリング改善**:
   - `img.onerror`で適切なErrorオブジェクトを作成
   - URLとエラー情報を含むメッセージ

3. **Manifest.jsonの修正**:
   - `web_accessible_resources`を追加
   - アイコン設定を追加

4. **CLAUDE.mdの修正**:
   - ブラウザ記述を「Chromium」に修正

#### 動作確認状況
**⚠️ 実際の動作確認は未完了です**
- ビルドとデプロイは実施
- 実際にエラーが解消したかは未確認
- 画像作成が成功するかは未確認

#### 変更ファイル
- `extension/src/content/deck-recipe/createDeckRecipeImage.ts`
- `extension/src/manifest.json`
- `CLAUDE.md`

---

## 2025-11-08 00:15: QRコード表示機能の修正

### 実装内容

#### 問題点
- チェックボックスをオンにしてもQRコードがデッキ画像に含まれない
- `createDeckRecipeImage.ts`で`includeQR && data.isPublic`の両方がtrueの場合のみQRコードを描画していた
- 非公開デッキではQRコードが一切表示されなかった

#### 解決策
1. QRコード描画条件を修正:
   - `includeQR && data.isPublic` → `includeQR`に変更
   - チェックボックスをオンにすれば常にQRコードを描画

2. 非公開デッキ用の視覚的フィードバック追加:
   - QRコードの上に黒い縁取り付きの白い「HIDDEN」テキストを表示
   - QRコード自体は描画されるが、非公開であることが明示される

3. Canvas高さ計算の修正:
   - `initializeCanvasSettings`関数でも`isPublic`チェックを削除
   - `includeQR`がtrueなら常にQRコード領域を確保

#### 動作確認
Node.jsでテストスクリプト `tmp/test-qr-code.ts` を作成して検証:
- ✓ 公開デッキ + QRコードあり → QRコードが右下に表示
- ✓ 非公開デッキ + QRコードあり → QRコード + "HIDDEN"テキスト表示
- ✓ 両画像のサイズが同一（1500x592px）

#### 変更ファイル
- `extension/src/content/deck-recipe/createDeckRecipeImage.ts`:
  - L117: `if (includeQR && data.isPublic)` → `if (includeQR)`に変更
  - L118: `drawQRCode`に`isPublic`パラメータを追加
  - L167: Canvas高さ計算から`isPublic`チェックを削除
  - L426-490: `drawQRCode`関数に非公開時のHIDDEN表示ロジックを追加

---

## 2025-11-07 22:45: バリデーション修正 - 部分的なデッキに対応

### 実装内容

#### 問題点
- すべてのカードタイプ（モンスター、魔法、罠）のセクションが必須だった
- デッキに魔法カードのみ、モンスターのみなどの場合にエラーになっていた
- エラーメッセージ: "モンスターカードセクション(.t_body.mlist_m)が#detailtext_main配下に見つかりません"

#### 解決策
- `validateDeckDetailPageStructure()`を修正:
  - セクションが存在しない場合はスキップ（エラーではない）
  - 存在するセクションについてのみ内部構造を検証
  - 少なくとも1つのカードセクションが見つかればOK

#### 検証
テストスクリプト `tmp/test-partial-deck-validation.js`:
- ✓ 魔法カードのみのデッキ → バリデーション成功
- ✓ モンスターと魔法のみのデッキ → バリデーション成功
- ✓ すべてのカードタイプがあるデッキ → バリデーション成功
- ✓ カードセクションが1つもないデッキ → エラーを正しく検出
- ✓ 実際のデッキページ → バリデーション成功

#### コミット
- e4d3838: fix: デッキに特定のカードタイプがない場合もバリデーションを通過するように修正

---

## 2025-11-07 22:24: APIドキュメント作成とビルド・デプロイ

### 実装内容

#### APIドキュメント
`docs/api/` ディレクトリに以下のドキュメントを作成:
- `README.md`: APIドキュメントの概要、DOM階層の重要性
- `card-search.md`: カード検索とパース関連API
- `deck-detail-parser.md`: デッキ詳細ページのパース関連API
- `session.md`: セッション管理API
- `deck-recipe-image.md`: デッキレシピ画像作成・ダウンロードAPI

各ドキュメントには以下を含む:
- 関数シグネチャと説明
- パラメータと戻り値
- エラーハンドリング方法
- 使用例
- 注意事項
- DOM階層の検証内容

#### その他の修正
- `downloadDeckRecipeImage()`: 正しいURL (`member_deck.action`) を使用

#### コミット
- 27fe6f3: docs: APIドキュメントを作成
- b553327: fix: downloadDeckRecipeImageで正しいデッキURLを使用

---

## 2025-11-07 21:45: DOM階層を正確に検証・使用するようにパーサーを修正

### 実装内容

#### 問題点
- `parseSearchResults()` と `parseCardSection()` がDOM階層を考慮せずに `.t_row` を取得していた
- ユーザーが指摘した正確なDOM階層を使用していなかった
- 実際のHTMLを取得せずに実装していた

#### 解決策
1. **デッキ詳細パーサー** (`deck-detail-parser.ts`)
   - `validateDeckDetailPageStructure()`: `#main980 > #article_body > #deck_detailtext > #detailtext_main` の完全な階層を検証
   - `parseCardSection()`: `#detailtext_main` を基準に `.t_body.mlist_m/s/t` を取得

2. **検索結果パーサー** (`card-search.ts`)
   - `parseSearchResults()`: `#main980 > #article_body > #card_list` の階層を検証
   - `.t_row` 取得前に親要素の存在確認を追加

#### 検証
- 実際のデッキ表示ページHTML (`tmp/deck-public.html`) で階層を確認
- 実際の検索結果ページHTML (`tmp/search-results-actual.html`) で階層を確認
- テストスクリプトで動作確認:
  - `tmp/test-parser-with-hierarchy.js`: デッキ表示ページから26枚のカードを正しく抽出
  - `tmp/test-search-parser.js`: 検索結果ページから10枚のカードを正しく抽出

#### DOM階層
- **デッキ表示**: `#main980 > #article_body > #deck_detailtext > #detailtext_main > .t_body > .t_row`
- **検索結果**: `#main980 > #article_body > #card_list > .t_row`

#### コミット
- cb9a136: fix: DOM階層を正確に検証・使用するようにパーサーを修正

---

## 2025-11-07: デッキレシピ画像作成機能の型設計改善

### 実装内容

#### 問題点
- `parseDeckDetail()`が`DeckInfo`を返すのに、わざわざ`DeckRecipeImageData`に変換していた
- 2つの異なる型（`DeckInfo`と`DeckRecipeImageData`）が同じデッキ情報を表現
- `convertDeckInfoToImageData()`という不自然な変換関数が必要

#### 解決策
1. **型定義の統一**
   - `CreateDeckRecipeImageOptions.deckData`の型を`DeckRecipeImageData`から`DeckInfo`に変更
   - `DeckRecipeImageData`型を削除（不要になる）

2. **createDeckRecipeImage.tsの修正**
   - `DeckInfo`から直接カード画像URLを構築するように変更
   - `buildCardImageUrl()`を使用して各カードから画像URLを生成
   - `CardSection[]`を動的に構築

3. **downloadDeckRecipeImage.tsの簡素化**
   - `convertDeckInfoToImageData()`関数を削除
   - `parseDeckDetail()`の結果を直接`createDeckRecipeImage()`に渡す

#### 変更されたファイル
- `extension/src/types/deck-recipe-image.ts`
- `extension/src/content/deck-recipe/createDeckRecipeImage.ts`
- `extension/src/content/deck-recipe/downloadDeckRecipeImage.ts`

### メリット

1. **型の一貫性**: パーサーが返す型をそのまま使用
2. **コードの簡潔性**: 不要な型変換処理の削除
3. **保守性向上**: 1つの型のみを管理すれば良い
4. **責任の明確化**: 画像URL構築はcreateD eckRecipeImage内部で完結

### デプロイとテスト

- ビルド成功
- デプロイ完了
- Chrome拡張の再起動後、テストページでボタン表示を確認
- デッキレシピ画像作成ボタンのクリックに成功

---

## 2025-11-07: SessionManagerクラスの実装とリファクタリング

### 実装内容

#### 1. SessionManagerクラスの実装 (session.ts)
- **目的**: cgidとytknを内部管理し、外部から隠蔽する統一インターフェースの提供
- **クラス構造**:
  - Private属性: `cgid: string | null`, `ytknCache: Map<number, string>`
  - Privateメソッド: `ensureCgid()`, `ensureYtkn(dno)`
  - Publicメソッド: `createDeck()`, `duplicateDeck()`, `saveDeck()`, `deleteDeck()`, `getCgid()`
- **機能**:
  - cgid/ytknの自動取得とキャッシュ管理
  - デッキ操作の統一インターフェース
  - 削除成功時の自動キャッシュクリア
- **エクスポート**: `export const sessionManager = new SessionManager();`

#### 2. deck-operations.tsのリファクタリング
- **関数リネーム**: 全ての関数に`Internal`サフィックスを追加
  - `createNewDeck` → `createNewDeckInternal`
  - `duplicateDeck` → `duplicateDeckInternal`
  - `saveDeck` → `saveDeckInternal`
  - `deleteDeck` → `deleteDeckInternal`
- **JSDocコメント追加**: `@internal SessionManager経由で呼び出すこと`
- **役割**: SessionManagerから呼び出される実装関数として明確化

#### 3. test-ui/index.tsの更新
- **ytknボタンの削除**: 単独のytkn取得UIを削除（不要な機能）
- **インポート変更**: `getCgid, getYtkn` → `sessionManager`
- **全ハンドラー関数の簡素化**:
  - `handleCreateDeck()`: 直接 `sessionManager.createDeck()` を呼ぶ
  - `handleDuplicateDeck()`: 直接 `sessionManager.duplicateDeck(4)` を呼ぶ
  - `handleDeleteDeck()`: 直接 `sessionManager.deleteDeck(4)` を呼ぶ
  - `handleSaveDeck()`: 直接 `sessionManager.saveDeck(dno, deckData)` を呼ぶ
  - `handleGetCgid()`: `sessionManager.getCgid()` を呼ぶ
- **効果**: cgid/ytkn取得ロジックの削除により、コードが大幅に簡潔化

#### 4. テストファイルの更新
- **deck-operations.test.ts**: 全てのテスト関数名を`*Internal`に更新
- **session.test.ts**: 
  - `getYtkn`テストを削除
  - `sessionManager.getCgid()`のテストに変更
  - 後方互換性テストを追加

### アーキテクチャの改善

**Before（問題のあった設計）**:
```typescript
// 外部から直接cgid/ytknを取得
const cgid = await getCgid();
const ytkn = await getYtkn(dno);
await saveDeck(cgid, dno, deckData, ytkn);
```

**After（新しい設計）**:
```typescript
// SessionManagerが内部で自動管理
await sessionManager.saveDeck(dno, deckData);
```

### メリット

1. **カプセル化**: cgid/ytknが完全に内部実装として隠蔽される
2. **シンプルなAPI**: 外部コードはセッション情報を意識する必要がない
3. **パフォーマンス向上**: 自動キャッシュにより不要なfetchを削減
4. **保守性向上**: セッション管理ロジックが一箇所に集約
5. **テスタビリティ**: SessionManagerクラスのテストが容易

### 後方互換性

- `getCgid()`関数を維持（deprecatedマーク付き）
- 既存の`handleGetCgid()`ハンドラーは引き続き動作

### バージョン更新

- `0.0.7` → `0.0.8` (パッチバージョンアップ: 内部アーキテクチャの改善)

---

## 2025-11-07: fetchからaxiosへの移行

### 実装内容

#### HTTP通信ライブラリの変更
- **理由**: 以前の調査で、Node.jsとブラウザで同じ実装を共有できるaxiosを使用する方針が決定済み
- **変更対象**:
  - `session.ts`: ytkn取得のfetch → axios.get
  - `deck-operations.ts`: 全てのfetch（GET/POST）→ axios
    - `createNewDeckInternal`: axios.get
    - `duplicateDeckInternal`: axios.get
    - `saveDeckInternal`: axios.post
    - `deleteDeckInternal`: axios.post

#### 変更の詳細

**Before (fetch)**:
```typescript
const response = await fetch(url, {
  method: 'GET',
  credentials: 'include'
});
if (!response.ok) throw new Error(...);
const html = await response.text();
```

**After (axios)**:
```typescript
const response = await axios.get(url, {
  withCredentials: true
});
const html = response.data;
```

### メリット

1. **一貫性**: Node.jsとブラウザで同じコードが使用可能
2. **簡潔性**: axios.dataで直接レスポンスにアクセス
3. **エラーハンドリング**: HTTPエラーが自動的に例外として扱われる
4. **開発効率**: テストスクリプトと本番コードで同じライブラリ

### 依存関係の追加

- `axios` パッケージを`extension/package.json`に追加

### バージョン更新

- なし（まだプロトタイプ/開発初期段階のため0.0.8のまま）

---


## 2025-11-07: デッキレシピ画像作成機能の完成（タイムスタンプ修正、サイドデッキ対応）

### 実装内容

#### 1. タイムスタンプの位置修正
- `createDeckRecipeImage.ts`の`drawTimestamp()`関数を修正
- 右下から左下に位置を変更（x: 10 * scale, y: height - 12 * scale）
- ISO 8601形式の日付フォーマットに変更（yyyy-mm-dd）
- Canvas状態リセット（textAlign: 'left', textBaseline: 'alphabetic'）

#### 2. デッキ情報抽出スクリプトの修正
- `tmp/extract-deck-1189.ts`を作成・修正
- **デッキ名の正確な取得**：metaタグのkeywordsから取得
- **枚数情報の正確な取得**：`td.num span`から各カードの枚数を取得
- 重複排除ロジックを削除し、HTMLの枚数情報をそのまま使用

#### 3. サイドデッキ対応の動作確認完了
- dno=1189のデッキ（サイドデッキ付き）で動作確認
- デッキ名：ドラゴンテイル 10月制限
- メイン：40枚（20種類）
- エクストラ：15枚（12種類）
- サイド：15枚（7種類）
- 3セクションすべてが正しく表示されることを確認

#### 4. 修正されたバグ
- デッキ名が"Unknown Deck"になる問題を修正
- カード枚数が不正確（重複カウント）な問題を修正
- タイムスタンプが表示されない問題を修正（Canvas状態のリセット）

### テスト結果
- ✅ メイン・エクストラ・サイドの3セクション画像生成成功
- ✅ タイムスタンプが左下に正しく表示
- ✅ ISO 8601形式の日付表示（exported on 2025-11-07）
- ✅ デッキ名とカード枚数が正確に表示

### 生成ファイル
- `tmp/deck-1189-full-data.json` - 抽出されたデッキ情報（完全版）
- `tmp/deck-1189-with-side.png` - サイドデッキ付きデッキレシピ画像

## 2025-11-07: parseDeckDetailの再実装とbuildCardImageUrl関数の追加

### 実装内容

#### 1. deck-detail-parser.tsの作成
- デッキ表示ページ（ope=1）専用のパーサーを新規作成
- **既存の`parseSearchResultRow()`を再利用**してコード重複を削減
- `tr.row`構造から正しくカード情報を取得
  - テーブル: `#monster_list`, `#spell_list`, `#trap_list`, `#extra_list`, `#side_list`
  - カード情報: `td.card_name`, `input.link_value`から取得
  - 枚数: `td.num span`から取得

#### 2. buildCardImageUrl()関数の追加
- `extension/src/api/card-search.ts`に追加
- カード画像URL構築を一元化
- `cardId`, `imageId`, `ciid`, `imgHash`から画像URLを構築
- DeckCard型にも画像情報を追加

#### 3. テスト
- `dev/test-parser.js`でデッキ表示ページのパース成功
- メインデッキ45枚、エクストラデッキ12枚を正しく取得
- 各カードの画像URLが正しく生成されることを確認

### 修正されたバグ
- `tr.row`セレクタで0件だった問題を修正（`tr[class~="row"]`に変更）

## 2025-11-07: デッキレシピ画像作成機能 Phase 1 完了

### 実装内容

#### 1. createDeckRecipeImage関数の実装
- `extension/src/content/deck-recipe/createDeckRecipeImage.ts`を作成
- Canvas APIを使用したデッキレシピ画像生成
- 旧実装の視覚デザインを完全再現（1926-2113行）
- Node.js環境でのテスト成功（`canvas`ライブラリ使用）
- ブラウザ環境との互換性確保

#### 2. 型定義の整備
- `extension/src/types/deck-recipe-image.ts`を作成
- すべての定数を型安全に定義
- カラーバリエーション（赤/青）対応

#### 3. レイアウトの完全実装
- Canvas lineWidth: 3 * scale
- 背景グラデーション（北東→南西）
- ヘッダー左側アクセントライン
- デッキ名位置（7, 35）
- セクションヘッダーグラデーション
- セクションヘッダーボーダー
- カードバック画像
- QRコード（公開デッキの場合）
- タイムスタンプ（左下、ISO 8601形式）

#### 4. 画像生成テスト
- 公開デッキ（dno=60）でテスト成功
- 全カラーバリエーション生成確認
  - 赤（プライベート）
  - 青（プライベート）
  - 赤（公開・QR付き）
  - 青（公開・QR付き）

### 技術的改善
- 環境検出による Canvas API 自動選択
- Refererヘッダー対応（画像取得）
- スケール倍率対応（高解像度出力）

---

## 過去の完了タスク（サマリー）

### 2025-11-04〜2025-11-06: 基盤実装フェーズ

**主要な成果:**
- Chrome拡張の基盤実装（TDD）
- ESモジュールエラー修正とビルドシステム構築
- Webpack ビルドシステムへの移行
- セッション管理機能の実装
- カード情報スクレイピング機能の完全実装
- カード検索パラメータの完全理解と実装

**技術的マイルストーン:**
- Jest + ts-jest によるテスト環境構築
- Webpack + Babel によるビルドパイプライン
- ポストビルドスクリプトによるマニフェスト修正
- Chrome DevTools Protocol を使った開発環境

### 2025-10-30〜2025-10-31: 調査フェーズ

**主要な成果:**
- Yu-Gi-Oh! デッキビルダーの完全調査
- デッキ操作API完全解明
- カード検索機能の徹底調査
- Chrome拡張設計ドキュメントの作成

**調査内容:**
- デッキ編集画面の HTML 構造解析
- カード追加ワークフローの解明
- API エンドポイントとパラメータの特定
- カードタイプ別フィールドマッピングの発見

**成果物:**
- 詳細な調査ドキュメント
- API 仕様書
- アーキテクチャ設計書

### 2025-11-09: Phase 2完了 - シャッフル機能とQRコード修正

**主要な成果:**
- ✅ シャッフル・ソート機能実装（sortfix対応）
- ✅ QRコードURL修正（cgid追加）
- ✅ デッキ画像ダイアログ位置修正

**実装内容:**

1. **シャッフル機能（Phase 2）**
   - シャッフルボタン・ソートボタン追加（ヒストグラムアイコン）
   - sortfix機能：カード右上1/4クリックで先頭固定
   - 南京錠インジケーター（青緑線・黒グレー縁取り）
   - sortfixカード：常時薄い青緑背景
   - アニメーション追加（0.4s cubic-bezier）
   - Fisher-Yates shuffleアルゴリズム実装

2. **QRコードバグ修正**
   - URLに`cgid`（ユーザーID）を追加
   - 修正前: `member_deck.action?ope=1&dno=${dno}` （動作しない）
   - 修正後: `member_deck.action?ope=1&cgid=${cgid}&dno=${dno}` （正常動作）
   - テストUIに`cgid`入力欄追加

3. **UI改善**
   - デッキ画像ダイアログを`position: absolute`に変更
   - ボタンと一緒にスクロールするように修正
   - ボタンスタイル統一（ytomo-neuron-btn）

**技術詳細:**
- sortfix状態管理：data-sortfix属性
- CSS疑似要素（::after）で南京錠表示
- ホバーUI：右上1/4エリアの視覚化
- カーソル位置に応じた明度変更

**ファイル構成:**
- `src/content/shuffle/` - シャッフル機能
  - `addShuffleButtons.ts` - ボタン追加
  - `shuffleCards.ts` - シャッフル・ソートロジック
  - `sortfixCards.ts` - sortfix機能
  - `index.ts` - エントリーポイント
- `src/content/styles/buttons.css` - 共通ボタンスタイル
- `src/types/deck-recipe-image.ts` - cgid追加

**バージョン:** 0.2.0

---

## 2025-11-13 (20:15): v0.3.0デモ用スクリーンショット撮影完了

### 実施内容

1. **日本語環境への切り替え**:
   - 日本語版URLに切り替え（`?request_locale=ja`パラメータ使用）
   - 英語環境では検索機能が動作しない問題を解決
   - Chromiumを再起動してクリーンな状態から撮影

2. **スクリーンショット7枚を撮影** (`docs/usage/`):
   - `01-initial-state.png` (259KB): 初期状態（デッキ名「超重オルフェ」、main 40枚、extra 15枚）
   - `02-deck-name-input.png` (260KB): デッキ名入力（「サンプルデッキ - v0.3.0」）
   - `03-card-detail-info.png` (333KB): カード詳細（Info）「オルフェゴール・ディヴェル」
   - `04-card-detail-related.png` (339KB): カード詳細（Related）関連カード5件表示
   - `05-card-detail-products.png` (339KB): カード詳細（Products）収録パック情報
   - `06-card-detail-qa.png` (339KB): カード詳細（Q&A）関連カード表示
   - `07-search-function.png` (341KB): 検索機能「ブラック・マジシャン」11件の検索結果

3. **撮影スクリプトの作成**:
   - `tmp/browser/capture-clean.js`: Chrome DevTools Protocol (CDP)を使用した自動スクリーンショット撮影
   - Node.js + WebSocket経由でChromiumを制御
   - 各操作の間に適切な待機時間を設定

### 技術詳細

**使用技術**:
- Chrome DevTools Protocol (CDP)
- WebSocket通信（`.chrome_playwright_ws`からURL取得）
- `Page.navigate`: ページ遷移
- `Page.captureScreenshot`: スクリーンショット撮影
- `Runtime.evaluate`: JavaScriptコード実行（DOM操作）
- `Input.dispatchMouseEvent`: マウスクリック
- `Input.dispatchKeyEvent`: キーボード入力（Ctrl+A）
- `Input.insertText`: テキスト入力

**操作フロー**:
1. 日本語版ページにナビゲート（5秒待機）
2. 初期状態を撮影
3. デッキ名入力欄に「サンプルデッキ - v0.3.0」を入力（1秒待機）
4. Cardタブに切り替え（1秒待機）
5. 左側デッキエリアの最初のカードの情報ボタンをクリック（2秒待機）
6. カード詳細タブ（Related/Products/Q&A）を順番にクリック（各2秒待機）
7. Searchタブに切り替え、検索欄に「ブラック・マジシャン」を入力（検索ボタンクリック、3秒待機）

**セレクタ**:
- デッキ名入力: `.deck-name-input`
- タブ切り替え: `.right-area > .tabs > button`
- カード選択: `.main-deck .card-item` → `.card-btn.top-left`
- カード詳細タブ: `.right-area button` (textContent で判定)
- 検索欄: `.search-input-bottom input`
- 検索ボタン: `.search-btn`

### 変更ファイル

- `tmp/browser/capture-clean.js`: 新規作成
- `tmp/browser/access-japanese-url.js`: 日本語版URL切り替えスクリプト
- `tmp/browser/switch-to-japanese.js`: 言語切り替えスクリプト
- `tmp/browser/test-search-japanese.js`: 日本語環境での検索テスト
- `docs/usage/*.png`: 7枚のスクリーンショット

### 成果物

v0.3.0デッキ編集機能のデモンストレーション用スクリーンショット一式が完成。
- デッキ名入力
- カード詳細表示（Info/Related/Products/Q&A）
- カード検索機能

### 反省点

1. **Headerタブの誤解**:
   - Headerタブがdisabledであることを理解せず、無駄に操作しようとした
   - 画面幅が広い場合はDeckタブも存在しないことを後から理解

2. **英語環境での検索失敗**:
   - 当初、英語環境で検索を試み、何度も失敗
   - 日本語環境に切り替える必要があることに気づくのが遅れた

3. **Vue.jsの状態保持**:
   - Chromiumを再起動しないと、前回のテストの影響（"TEST NAME"）が残った
   - ページリロードだけでは不十分だった

### 次のステップ

- `docs/usage/index.md` にスクリーンショットを埋め込む
- 使い方ドキュメントを更新

---

## 2025-11-14 (03:31): v0.3.0 デッキ編集機能ドキュメント更新

### 概要

前回撮影したv0.3.0デッキ編集機能のスクリーンショット（全7枚）をドキュメントに組み込み、ユーザー向け使い方ガイドを完成させました。

### 実施内容

#### 1. `docs/usage/deck-edit.md` の更新

**追加したセクション:**

1. **UIの全体構成セクション**
   - スクリーンショット: `images/01-initial-state.png`
   - 内容: 2カラム構成（左側デッキエリア、右側タブエリア）の説明
   - 各タブ（Header/Search/Card）の役割を明記

2. **カード詳細表示セクション（機能7として追加）**
   - Info タブ: `images/03-card-detail-info.png`
   - Related タブ: `images/04-card-detail-related.png`
   - Products タブ: `images/05-card-detail-products.png`
   - Q&A タブ: `images/06-card-detail-qa.png`
   - 各タブの表示内容を詳細に説明

3. **カード検索エリアの拡充**
   - スクリーンショット: `images/07-search-function.png`
   - 使い方の手順を追加（1〜4ステップ）

4. **使用例の改善**
   - デッキ名入力: `images/02-deck-name-input.png`
   - 基本的なデッキ編集フローにステップ3として追加

#### 2. `docs/usage/index.md` の更新

- バージョン情報を **0.2.0 → 0.3.0** に更新

### 変更ファイル

- `docs/usage/deck-edit.md`: スクリーンショット7枚を組み込み、説明を大幅に拡充
- `docs/usage/index.md`: バージョン情報更新

### 成果物

v0.3.0デッキ編集機能の完全なビジュアルガイドが完成しました。
- UIの全体構成が一目で理解できる
- 各機能（カード検索、詳細表示、デッキ名入力）の使い方が画像付きで説明されている
- カード詳細の4つのタブ（Info/Related/Products/Q&A）それぞれのスクリーンショット付き

### 次のステップ

- 必要に応じてchangelog（`docs/changelog/v0.3.0.md`）を更新
- README.mdにv0.3.0の新機能を追加

---

## 2025-11-14 (03:45): Products/Q&Aスクリーンショット修正

### 概要

Products/Q&Aタブのスクリーンショットが正しく撮影されていなかった問題を調査・修正しました。

### 問題の詳細

**症状:**
- `05-card-detail-products.png` と `06-card-detail-qa.png` がRelatedタブの画像と同一
- ファイルサイズが全て346190バイトで完全一致

**根本原因:**
1. **WebSocket URL の誤り**: ブラウザレベル（`/devtools/browser/...`）のURLを使用していたため、`Page.navigate` や `Runtime.evaluate` が機能していなかった
2. **Runtime.evaluateの構文エラー**: `return`文を直接使用していたため、"SyntaxError: Illegal return statement" が発生

### 解決方法

#### 1. WebSocket URL の修正

**修正前（誤り）:**
```bash
# /json/version から取得（ブラウザレベル）
ws://localhost:9222/devtools/browser/a93a1def-c021-41a1-b2db-0f4c95af67dc
```

**修正後（正解）:**
```bash
# /json から最初のページを取得（ページレベル）
curl -s http://localhost:9222/json | grep -o 'ws://localhost:9222/devtools/page/[^"]*' | head -1
ws://localhost:9222/devtools/page/BCF18CA54C69DCDE91B9D563E036DDFC
```

#### 2. Runtime.evaluateの構文修正

**修正前（エラー）:**
```javascript
await sendCommand('Runtime.evaluate', {
  expression: `
    const cardTabs = document.querySelectorAll('.card-detail-tabs button');
    const targetTab = Array.from(cardTabs).find(t => t.textContent.trim() === 'Products');
    if (targetTab) targetTab.click();
  `
});
```

**修正後（IIFE使用）:**
```javascript
await sendCommand('Runtime.evaluate', {
  expression: `
    (() => {
      const cardTabs = document.querySelectorAll('.card-detail-tabs button');
      const targetTab = Array.from(cardTabs).find(t => t.textContent.trim() === 'Products');
      if (targetTab) targetTab.click();
    })()
  `
});
```

### 調査プロセス

1. **ファイルサイズ比較**: 3つのファイルが完全に同一サイズ（346190B）であることを確認
2. **接続テスト**: WebSocket接続をテストし、ブラウザレベルURLでは `Page.navigate` が使えないことを発見
3. **DOM調査**: カード詳細タブの構造を調査し、セレクタ `.card-detail-tabs button` が正しいことを確認
4. **構文エラー発見**: Runtime.evaluateで `return` 文がエラーになることを特定
5. **修正・再撮影**: 両方の問題を修正し、スクリーンショットを再撮影

### 変更ファイル

- `scripts/screenshots/deck-edit/capture-screenshots.js`: タブクリック処理をIIFEで囲むように修正
- `.chrome_playwright_ws`: ページレベルのWebSocket URLに更新
- `docs/usage/images/04-card-detail-related.png`: 再撮影（346190バイト）
- `docs/usage/images/05-card-detail-products.png`: 再撮影（279430バイト）
- `docs/usage/images/06-card-detail-qa.png`: 再撮影（299406バイト）

### 成果物

Products/Q&Aタブのスクリーンショットが正しく撮影されました。
- 各タブで異なるファイルサイズ（異なる画像であることを確認）
- Products: パック・商品情報が正しく表示
- Q&A: 公式Q&A情報が正しく表示

### 教訓

1. **WebSocket URLの種類**: CDP には「ブラウザレベル」と「ページレベル」のURLがあり、ページ操作にはページレベルが必要
2. **Runtime.evaluateの制約**: 式として評価されるため、トップレベルの `return` 文は使えない（IIFEで囲む必要がある）
3. **ファイルサイズ比較**: スクリーンショットが正しく撮影されたか確認する簡単な方法

---

## 2025-11-14 (04:04): 画像管理の整理

### 概要

`docs/usage/images/` と `public/images/` の画像が整理されておらず、重複や不要な画像が多数存在していた問題を解決しました。

### 問題の詳細

**問題点:**
1. ✗ `docs/usage/images/` にサブフォルダなし（24ファイルが直下に配置）
2. ✗ `public/images/` と `docs/usage/images/` で17ファイルが重複
3. ✗ 不要な画像が残存（`覇王魔術師_2025-11-09T09-23-27.jpg` など）
4. ✗ シンボリックリンクなどの管理手法が未使用

### 整理方針

**画像の用途を整理:**
- **`public/images/`**: 拡張機能で使用する画像（今回は使用されていないため削除）
- **`docs/usage/images/`**: ドキュメント用画像（機能別にサブフォルダで分類）

**新しいディレクトリ構造:**
```
docs/usage/images/
├── deck-edit/       # デッキ編集機能（7ファイル）
├── shuffle-sort/    # シャッフル・ソート機能（4ファイル）
├── deck-image/      # デッキ画像作成機能（9ファイル）
└── README.md        # 画像一覧とスクリーンショット撮影方法
```

### 実施内容

#### 1. サブディレクトリ作成と画像移動

```bash
# deck-edit/
01-initial-state.png
02-deck-name-input.png
03-card-detail-info.png
04-card-detail-related.png
05-card-detail-products.png
06-card-detail-qa.png
07-search-function.png

# shuffle-sort/
shuffle-sort-animation.gif
shuffle-sort-buttons.png
card-lock-feature.png
card-locked-state.png

# deck-image/
deck-image-button.png
deck-image-dialog.gif
image-dialog-color-red.png
image-dialog-color-blue.png
image-dialog-qr-on.png
image-dialog-qr-off.png
image-dialog-download-button.png
image-dialog-overview.png
image-dialog-deck-name.png
```

#### 2. 不要な画像削除

- `覇王魔術師_2025-11-09T09-23-27.jpg` (4.9MB): テスト用画像、不要
- `deck-recipe-sample.png` (835KB): 使用されていない
- `deck-display-page-overview.png` (3.9MB): 使用されていない

#### 3. `public/images/` 削除

拡張機能のソースコードで使用されていないため、ディレクトリごと削除。

#### 4. ドキュメント内の画像パス更新

**`docs/usage/deck-edit.md`:**
- `./images/01-initial-state.png` → `./images/deck-edit/01-initial-state.png`
- （全7枚のスクリーンショット）

**`docs/usage/index.md`:**
- `./images/shuffle-sort-animation.gif` → `./images/shuffle-sort/shuffle-sort-animation.gif`
- `./images/deck-image-button.png` → `./images/deck-image/deck-image-button.png`
- （全13枚の画像）

#### 5. README.md 更新

新しいディレクトリ構造を反映し、各サブフォルダの内容を説明。

### 変更ファイル

**削除:**
- `public/images/` (ディレクトリごと削除)
- `docs/usage/images/覇王魔術師_2025-11-09T09-23-27.jpg`
- `docs/usage/images/deck-recipe-sample.png`
- `docs/usage/images/deck-display-page-overview.png`

**移動:**
- 20ファイルをサブディレクトリに移動

**更新:**
- `docs/usage/deck-edit.md`: 画像パス更新（7箇所）
- `docs/usage/index.md`: 画像パス更新（13箇所）
- `docs/usage/images/README.md`: 新構造に全面改訂

### 成果物

**整理後の状態:**
- ✅ 機能別にサブフォルダで分類（3フォルダ）
- ✅ 重複なし（`public/images/` 削除）
- ✅ 不要な画像削除（9.7MB削減）
- ✅ ドキュメント内のパス全て更新
- ✅ README.mdで構造を文書化

**合計ファイル数:**
- 整理前: 24ファイル（直下） + 17ファイル（public/images/）= 41ファイル
- 整理後: 20ファイル（3サブフォルダ） + 1 README = 21ファイル

### 方針の決定（修正版）

**❌ 当初の誤った判断:**
- `public/images/` が未使用だと判断して削除してしまった
- しかし実際は `src/options/App.vue` で使用されていた

**✅ 正しい方針（シンボリックリンク使用）:**
- **実体**: `docs/usage/images/` に配置（ドキュメントが正確な情報源）
- **シンボリックリンク**: `public/images/` から `docs/usage/images/` へリンク
- optionsページで使用される画像:
  - `shuffle-sort-animation.gif` → `docs/usage/images/shuffle-sort/`
  - `deck-recipe-sample.png` → `docs/usage/images/deck-image/`

**シンボリックリンクの利点:**
- 画像の重複管理を避ける
- ドキュメントと拡張機能で同じ画像を使用
- 更新時に1箇所を変更するだけで済む

---

## 2025-11-14 (04:16): 画像管理方針の修正（シンボリックリンク採用）

### 概要

前回の作業で `public/images/` を削除してしまったが、実際には `src/options/App.vue` で使用されていた。シンボリックリンクを使用して正しく復元しました。

### 問題の発見

**誤った判断:**
- `grep -r "public/images"` でソースコードを検索したが、Vueビルドシステムでは `/images/` という相対パスで参照されるため発見できなかった
- `src/options/App.vue` で以下の2つの画像を使用：
  - `/images/shuffle-sort-animation.gif`
  - `/images/deck-recipe-sample.png`

### 解決方法

**シンボリックリンクによる管理:**

1. **実体の配置先**: `docs/usage/images/`（機能別サブフォルダ）
   - `docs/usage/images/shuffle-sort/shuffle-sort-animation.gif`
   - `docs/usage/images/deck-image/deck-recipe-sample.png`

2. **シンボリックリンク**: `public/images/`
   ```bash
   public/images/shuffle-sort-animation.gif -> ../../docs/usage/images/shuffle-sort/shuffle-sort-animation.gif
   public/images/deck-recipe-sample.png -> ../../docs/usage/images/deck-image/deck-recipe-sample.png
   ```

### 最終的なディレクトリ構造

```
docs/usage/images/
├── deck-edit/           # デッキ編集機能（7ファイル）
├── shuffle-sort/        # シャッフル・ソート機能（4ファイル + deck-recipe-sample.png復元前は3）
│   └── shuffle-sort-animation.gif  ← 実体（optionsページでも使用）
├── deck-image/          # デッキ画像作成機能（10ファイル）
│   └── deck-recipe-sample.png      ← 実体（optionsページでも使用、gitから復元）
└── README.md

public/images/
├── shuffle-sort-animation.gif → ../../docs/usage/images/shuffle-sort/
└── deck-recipe-sample.png     → ../../docs/usage/images/deck-image/
```

### 復元作業

1. `public/images/` ディレクトリ再作成
2. `deck-recipe-sample.png` をgitから復元（835KB）
3. `docs/usage/images/deck-image/` に配置
4. シンボリックリンク作成

### 教訓

1. **Vueビルドシステムの理解**: `public/` の静的ファイルは `/` でアクセスされる
2. **検索の盲点**: 相対パス参照（`/images/`）は `public/images` で検索しても見つからない
3. **ソースファイルの確認**: `src/` 内の `.vue` ファイルを確認すべきだった
4. **シンボリックリンクの有効性**: 重複管理を避け、単一の情報源を維持できる


---

## 2025-11-14 04:30: オプションページに独自デッキ編集画面の画像追加

### 実施内容

**目的**: オプションページ（`src/options/App.vue`）に独自デッキ編集画面のスクリーンショットを追加し、機能説明を強化

### 追加した画像（3枚厳選）

1. **deck-edit-initial-state.png** (331 KB)
   - デッキ編集画面の全体UI（初期状態）
   - DNO入力、カード検索エリア、デッキエリア、カード詳細エリアを全て表示

2. **deck-edit-search-function.png** (341 KB)
   - カード検索機能の詳細
   - リスト表示、ソート機能、無限スクロール対応を示す

3. **deck-edit-card-detail-info.png** (332 KB)
   - カード詳細表示（Infoタブ）
   - カードステータス、効果テキスト、制限情報を表示

### 実装手順

#### 1. シンボリックリンク作成 (`public/images/`)

```bash
ln -s ../../docs/usage/images/deck-edit/01-initial-state.png public/images/deck-edit-initial-state.png
ln -s ../../docs/usage/images/deck-edit/07-search-function.png public/images/deck-edit-search-function.png
ln -s ../../docs/usage/images/deck-edit/03-card-detail-info.png public/images/deck-edit-card-detail-info.png
```

#### 2. Vue コンポーネント更新 (`src/options/App.vue`)

**変更箇所**: 148-173行目の `deckEditFeature` 定義

**Before:**
```javascript
images: [],
```

**After:**
```javascript
images: [
  { src: '/images/deck-edit-initial-state.png', alt: 'デッキ編集画面の全体UI（初期状態）' },
  { src: '/images/deck-edit-search-function.png', alt: 'カード検索機能（リスト表示・ソート）' },
  { src: '/images/deck-edit-card-detail-info.png', alt: 'カード詳細表示（Infoタブ）' }
],
```

**追加セクション**: `usage` に「アクセス方法」を追加

```html
<h5>アクセス方法</h5>
<ul>
  <li>URL: <code>https://www.db.yugioh-card.com/yugiohdb/#/ytomo/edit</code></li>
  <li>デッキ表示ページから「編集」ボタンでアクセス可能です。</li>
</ul>
```

#### 3. ドキュメント作成 (`public/images/README.md`)

- シンボリックリンク構造の説明
- 使用箇所の明記
- 新しい画像の追加方法
- 注意事項（単一ソース維持の重要性）

#### 4. ビルド＆デプロイ

```bash
npm run build      # 成功: 3つの新しい画像がdist/images/にコピーされた
./scripts/deploy.sh # 成功: WSL本番環境にデプロイ完了
```

### 最終的なファイル構成

```
public/images/
├── shuffle-sort-animation.gif       -> ../../docs/usage/images/shuffle-sort/
├── deck-recipe-sample.png           -> ../../docs/usage/images/deck-image/
├── deck-edit-initial-state.png      -> ../../docs/usage/images/deck-edit/01-initial-state.png
├── deck-edit-search-function.png    -> ../../docs/usage/images/deck-edit/07-search-function.png
├── deck-edit-card-detail-info.png   -> ../../docs/usage/images/deck-edit/03-card-detail-info.png
└── README.md  # 新規作成
```

### 効果

**オプションページでの表示強化:**
- 独自デッキ編集画面の機能が視覚的に理解しやすくなった
- 3つの代表的スクリーンショットで主要機能をカバー：
  1. 全体UI構成
  2. カード検索機能
  3. カード詳細表示
- アクセス方法を明示し、ユーザーが機能を発見しやすくなった

**画像管理の一貫性:**
- `docs/usage/images/` を単一の情報源として維持
- `public/images/` はシンボリックリンクのみ（5ファイル）
- ビルド時にWebpackが自動追跡・コピー

### 関連ファイル

- `src/options/App.vue`: deckEditFeature更新（148-173行目）
- `public/images/`: 3つのシンボリックリンク追加
- `public/images/README.md`: 新規作成
- `docs/usage/images/deck-edit/`: 実体ファイル（7枚）
- `tasks/done.md`: 本記録

---

## 2025-11-14 04:45: v0.3.0リリース準備完了・PR#3更新

### 実施内容

**目的**: v0.3.0のリリース準備を完了し、devブランチへのPRを更新

### 完了タスク

1. **Changelog作成**
   - docs/changelog/v0.3.0.md: 詳細なリリースノート作成
   - docs/changelog/index.md: バージョン一覧とロードマップ更新
   - ユーザー向けドキュメントから絵文字削除

2. **オプションページ改善**
   - 独自デッキ編集画面の画像を3枚追加
   - src/options/App.vue: deckEditFeatureに画像とアクセス方法追加

3. **画像管理の整理**
   - docs/usage/images/ を機能別サブフォルダに整理
   - public/images/ に3つのシンボリックリンク追加
   - public/images/README.md作成

4. **スクリーンショット自動化**
   - scripts/screenshots/deck-edit/capture-screenshots.js作成
   - Products/QAタブのスクリーンショット重複問題修正

5. **ドキュメント更新**
   - docs/usage/deck-edit.md: 7つのスクリーンショット追加
   - docs/usage/index.md: 画像パス更新、バージョン0.3.0に変更

6. **タスク管理**
   - tasks/todo.md: リリース準備タスクをチェック済みに更新

### Git作業

```bash
git add -A
git commit -m "docs: v0.3.0リリース準備完了"
git push origin feature/v0.3.0-tests
gh pr comment 3 --body "最新のコミット: v0.3.0リリース準備完了"
```

### テスト結果

全テストPass（125 tests）
- 単体テスト: 9 tests
- 結合テスト: 17 tests
- コンポーネントテスト: 51 passed / 3 skipped

### ビルド＆デプロイ

- npm run build: 成功
- ./scripts/deploy.sh: WSL本番環境へデプロイ完了

### PR状況

- **PR#3**: https://github.com/TomoTom0/YuGiOh-NEXT/pull/3
- **Base**: dev
- **Status**: OPEN
- **コミット追加**: b8cdf68 "docs: v0.3.0リリース準備完了"

### リリース準備状況

- [x] バージョン更新（0.3.0）
- [x] CHANGELOG作成
- [x] ドキュメント整備
- [x] オプションページ改善
- [x] 画像管理整理
- [x] テスト全Pass
- [x] ビルド・デプロイ確認
- [x] Git保存・プッシュ・PR更新
- [ ] 最終動作確認（Chrome/Edge）← 次のステップ

### 次のステップ

1. Chrome/Edgeでの最終動作確認
2. 問題なければPR#3をdevにマージ
3. v0.3.0リリース

---

## 2025-11-14 05:00: ブランチ保護ルール設定完了

### 実施内容

**目的**: main/devブランチに保護ルールを適用し、特定のブランチからのみPRを受け付けるように設定

### 実装内容

#### 1. GitHub Actionsワークフロー
- **.github/workflows/branch-protection.yml**
  - mainへのPR: devブランチからのみ許可
  - devへのPR: feature/fix/docs/refactor/testブランチからのみ許可
  - ポリシー違反時はワークフロー失敗→マージ不可

#### 2. ブランチ保護設定スクリプト
- **scripts/setup/setup-branch-protection.sh**
  - GitHub REST APIを使用してブランチ保護を設定
  - main/devブランチに適用

#### 3. 保護ルール詳細

**mainブランチ（最も厳格）**:
- PR必須（直接push禁止）
- devからのPRのみ（GitHub Actions強制）
- ステータスチェック必須: check-branch-policy
- 署名済みコミット必須
- force push禁止
- 削除禁止
- 管理者も従う（enforce_admins: true）
- 会話解決必須

**devブランチ（中程度）**:
- PR必須（直接push禁止）
- feature/fix/docs/refactor/testからのPRのみ（GitHub Actions強制）
- ステータスチェック必須: check-branch-policy
- 署名済みコミット必須
- force push禁止
- 削除禁止
- 会話解決必須

#### 4. ドキュメント
- **docs/dev/branch-protection.md**
  - ブランチ戦略の説明
  - 保護ルール詳細
  - 設定方法
  - 署名済みコミットの設定手順

### 技術的な工夫

#### ブランチ制限の実現方法
- GitHub APIではベースブランチ制限を直接設定できない
- **GitHub Actions + ステータスチェック**で実現
  1. PRが作成されるとワークフローが実行
  2. baseブランチとheadブランチを検証
  3. ポリシー違反→ワークフロー失敗
  4. ステータスチェック必須設定により、失敗時はマージ不可

#### APIパラメータ形式
- 当初`-f`フラグでJSON文字列を渡して失敗
- `--input -`でHeredoc形式に修正して成功

### 実行結果

```bash
./scripts/setup/setup-branch-protection.sh
```

**mainブランチ**:
- required_status_checks: ✓ (strict: true, contexts: ["check-branch-policy"])
- required_signatures: ✓
- enforce_admins: ✓
- required_conversation_resolution: ✓
- allow_force_pushes: ✗
- allow_deletions: ✗

**devブランチ**:
- required_status_checks: ✓ (strict: true, contexts: ["check-branch-policy"])
- required_signatures: ✓
- enforce_admins: ✗（緊急時の対応を可能にする）
- required_conversation_resolution: ✓
- allow_force_pushes: ✗
- allow_deletions: ✗

### コミット

- e300252: "ci: add branch protection rules and workflow"
- 750117c: "fix(ci): fix branch protection script JSON format"

### 次のステップ

- PR#3のレビュー結果確認
- 問題なければdevにマージ
- devからmainへのPR作成（この時点でブランチ保護が動作開始）

---

## [2025-11-14 07:05:45] CardQA & タブ切り替え改善

### 実施内容

1. **FAQ質問ボックスのwidth修正**
   - `src/components/CardQA.vue` のCSS（line 262-268）
   - `.qa-item` に `width: 100%` を追加

2. **質問文のカードリンク確認**
   - 既に実装済みであることを確認
   - `parseCardLinks` が質問文に適用済み（lines 16-25）
   - カード名クリックで `handleCardLinkClick` が動作する

3. **タブ切り替え時の画像再レンダリング問題修正**
   - `src/components/RightArea.vue` (lines 26, 30, 45)
   - `v-if` を `v-show` に変更
   - DOM要素の破棄・再生成を防止し、画像の再レンダリングを回避

### 修正ファイル

- `src/components/CardQA.vue`: CSS `.qa-item` width追加
- `src/components/RightArea.vue`: `v-if` → `v-show` 変更

### Build & Deploy

```bash
npm run build
./scripts/deploy.sh
```

---

## [2025-11-14 08:09:21] カード詳細UI改善とFAQ状態管理バグ修正

### 実施内容

#### 1. FAQ横スクロール問題の修正
- **ファイル**: `src/components/CardQA.vue`
- **問題**: FAQ項目にpaddingがあると横スクロールが発生
- **解決策**: `box-sizing: border-box` を `.card-qa` と全ての子要素に適用
  ```scss
  .card-qa {
    width: 100%;
    box-sizing: border-box;
    * {
      box-sizing: border-box;
    }
  }
  ```

#### 2. Info補足情報のカードリンク対応
- **ファイル**: `src/components/CardInfo.vue`
- **機能追加**:
  - `parseCardLinks()` メソッド実装（`{{カード名|cid}}` 形式のパース）
  - `handleCardLinkClick()` メソッド実装（カードリンククリック処理）
  - 補足情報（Detail）とペンデュラム補足情報（Pend. Detail）両方に適用
- **挙動**: カード名クリック → カード詳細取得 → CardタブのInfoタブに遷移

#### 3. ペンデュラム補足情報の表示追加
- **ファイル**: `src/components/CardInfo.vue`, `src/components/CardDetail.vue`
- **追加Props**: `pendulumSupplementInfo`, `pendulumSupplementDate`
- **表示順序**:
  1. Pend. Text（ペンデュラムテキスト）
  2. Pend. Detail（ペンデュラム補足情報）
  3. Card Text（カードテキスト）
  4. Detail（補足情報）

#### 4. QAタブの簡素化
- **ファイル**: `src/components/CardQA.vue`
- **変更内容**:
  - 補足情報の表示を削除（Infoタブに統合）
  - `.qa-header` のスタイル簡素化（border/background/padding削除）
  - カード名を14pxのboldテキストとしてシンプルに表示

#### 5. Info tab width問題の修正
- **ファイル**: `src/components/CardInfo.vue`
- **修正内容**:
  - 全要素に `width: 100%`, `box-sizing: border-box` を追加
  - `word-wrap: break-word`, `overflow-wrap: break-word` で長文対応
  - カードテキスト、補足情報、ペンデュラム関連全てに適用
  - 横スクロールを完全に防止

#### 6. UIアニメーション追加
- **FAQ展開/縮小アニメーション** (`src/components/CardQA.vue`):
  ```vue
  <transition name="qa-expand">
  ```
  - 展開: 0.3s ease-out (max-height, opacity, translateY)
  - 縮小: 0.2s ease-in

- **タブ切り替えアニメーション** (`src/components/RightArea.vue`):
  ```scss
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  ```
  - 0.2s ease-in-out

- **カード情報更新アニメーション** (`src/components/CardInfo.vue`):
  ```scss
  @keyframes cardInfoFadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  ```
  - 0.25s ease-out

- **ボタンホバー/アクティブエフェクト**:
  - ホバー: `scale(1.05)` または `scale(1.08)`
  - アクティブ: `scale(0.95)`

#### 7. バージョン管理の修正
- **ファイル**: `version.dat`
- **修正**: 0.4.0 → 0.3.1
- **理由**: milestone.mdに従い、v0.4.0はPhase 4の機能実装後
- **コミット**: 67b6aa2
  - 0.3.0ベース機能実装
  - オプションページUI改善
  - タブ構造変更

#### 8. 🚨 重大なバグ修正: FAQ状態管理
- **ファイル**: `src/components/CardQA.vue`
- **問題**: FAQ状態がindex-basedで管理されていた
  ```javascript
  // 問題のあるコード
  expandedQA.value[index] = true
  qaAnswers.value[index] = faqDetail.answer
  ```
  - Card A FAQ[0] (faqId=100) を展開 → `qaAnswers[0] = "Card A answer"`
  - Card Bに切り替え
  - Card B FAQ[0] (faqId=300) が表示される → **Card Aの回答が表示される（バグ）**

- **解決策**: faqId-basedに変更
  ```javascript
  // 修正後
  const expandedQA = ref({})  // faqId → boolean
  const loadingQA = ref({})   // faqId → boolean
  const qaAnswers = ref({})   // faqId → answer text

  const expandQA = async (faqId) => {
    if (qaAnswers.value[faqId]) {
      expandedQA.value[faqId] = true
      return
    }

    loadingQA.value[faqId] = true
    expandedQA.value[faqId] = true

    try {
      const faqDetail = await getFAQDetail(faqId)
      qaAnswers.value[faqId] = faqDetail.answer
    } finally {
      loadingQA.value[faqId] = false
    }
  }
  ```

- **効果**:
  - 異なるカードのFAQが回答を共有しない（faqId単位で管理）
  - 同じfaqIdを持つFAQは展開状態を共有（ユーザー要件）

- **影響範囲**:
  - テンプレート: `v-if="!expandedQA[qa.faqId]"` に変更
  - `expandQA(qa.faqId)`, `collapseQA(qa.faqId)` の引数変更
  - 全ての状態管理がfaqIdベースに統一

### API拡張

#### card-search.ts
- **ファイル**: `src/api/card-search.ts`
- **変更**: `getCardDetail()` の引数を拡張
  ```typescript
  export async function getCardDetail(
    cardOrId: CardInfo | string,  // CardInfo | cid文字列
    lang?: string
  ): Promise<CardDetail | null>
  ```
- **目的**: カードリンククリック時に cid のみから詳細情報を取得可能に

### 修正ファイル一覧

1. `src/components/CardQA.vue`
   - box-sizing追加
   - QAヘッダー簡素化
   - FAQ展開/縮小アニメーション
   - **faqId-based状態管理への変更**（重大バグ修正）

2. `src/components/CardInfo.vue`
   - parseCardLinks/handleCardLinkClick実装
   - ペンデュラム補足情報props追加
   - width/box-sizing/word-wrap修正
   - カード情報更新アニメーション

3. `src/components/CardDetail.vue`
   - ペンデュラム補足情報propsの受け渡し

4. `src/components/RightArea.vue`
   - タブ切り替えアニメーション（既存のv-show活用）

5. `src/api/card-search.ts`
   - getCardDetailの引数拡張（CardInfo | string）

6. `version.dat`
   - バージョン修正（0.4.0 → 0.3.1）

### Git コミット

- **67b6aa2**: オプションページUI改善
- **98d711d**: tasks: options page完了ステータス更新
- **23e553d**: options: タブと画像追加
- **b71950a**: fix: オプションページ画像表示改善
- **93b65c3**: options: 画像と構造改善
- **30c72d2**: **fix(CardQA): FAQ状態管理をindex-basedからfaqId-basedに変更**（重大バグ修正）

### Build & Deploy

```bash
npm run build
./scripts/deploy.sh
```

### 次のタスク

- テスト追加（CardQA faqId-based状態管理、CardInfo parseCardLinks）
- ドキュメント更新（カードリンク機能、FAQ挙動説明）

デプロイ先: `/home/tomo/user/Mine/_chex/src_ygoNeuronHelper`
