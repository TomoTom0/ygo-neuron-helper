# 遊戯王DBカード検索API 完全仕様書

最終更新: 2025-11-07

## 概要

遊戯王公式データベースのカード検索APIは、GETメソッドでクエリパラメータを送信する形式です。

**ベースURL**: `https://www.db.yugioh-card.com/yugiohdb/card_search.action`

**検証状況**: ✅ 全パラメータのマッピング検証完了（2025-11-07）
- 検索フォームHTMLから正確なvalue→label対応を抽出
- 実装コードとの照合完了
- APIテストによる動作確認済み

## 必須パラメータ

### request_locale
- **説明**: 言語設定
- **型**: string
- **値**: `ja` (日本語), `en` (英語), など
- **必須**: はい（URLに明示的に含める必要がある）

### ope
- **説明**: 操作コード
- **型**: string
- **値**: `1` = 検索実行
- **必須**: 検索実行時は必須

### sess
- **説明**: セッション識別子
- **型**: string
- **値**: `1` など（セッションごとに変わる可能性がある）
- **必須**: 検索実行時は必須

## 基本検索パラメータ

### keyword
- **説明**: 検索キーワード
- **型**: string
- **デフォルト**: `""` (空文字列)
- **例**: `keyword=ブラック・マジシャン`

### stype
- **説明**: 検索タイプ
- **型**: string
- **値**:
  - `1`: カード名検索
  - `2`: カードテキスト検索
  - `3`: ペンデュラム効果検索
  - `4`: カードNo検索
- **デフォルト**: `1`

### ctype
- **説明**: カードタイプ
- **型**: string
- **値**:
  - `""` (空): すべてのカード
  - `1`: モンスターカード
  - `2`: 魔法カード
  - `3`: 罠カード
- **デフォルト**: `""` (空文字列)

## 表示・ソートパラメータ

### rp
- **説明**: 1ページあたりの結果数 (Results Per Page)
- **型**: integer
- **UIに表示される値**: `10`, `25`, `50`, `100`
- **実際に使用可能な値**: `1`〜`2000`
- **デフォルト**: `10`
- **注意**: UIには`2000`は表示されないが、実際には指定可能で全結果を1ページに表示できる

### sort
- **説明**: ソート順
- **型**: string
- **値**:
  - `1`: 50音順
  - `2`: レベル／ランク順（大きい順）
  - `3`: レベル／ランク順（小さい順）
  - `4`: 攻撃力順（大きい順）
  - `5`: 攻撃力順（小さい順）
  - `6`: 守備力順（大きい順）
  - `7`: 守備力順（小さい順）
  - `8`: ペンデュラムスケール順（大きい順）
  - `9`: ペンデュラムスケール順（小さい順）
  - `11`: リンク数（多い順）
  - `12`: リンク数（少ない順）
  - `20`: 発売日（古い順）
  - `21`: 発売日（新しい順）
- **デフォルト**: `1`
- **注意**: `10`は存在しない

### mode
- **説明**: 表示モード（詳細は不明）
- **型**: string
- **デフォルト**: `""` (空文字列)

## モンスターカード属性パラメータ

### attr
- **説明**: モンスター属性
- **型**: string (複数選択可能)
- **検証状況**: ✅ 検証済み（検索フォーム分析 + APIテスト）
- **値**:
  - `11`: 光属性
  - `12`: 闇属性
  - `13`: 水属性
  - `14`: 炎属性
  - `15`: 地属性
  - `16`: 風属性
  - `17`: 神属性
- **複数選択**: `attr=11&attr=12&attr=14` のように同じパラメータ名を繰り返す

### species
- **説明**: モンスター種族
- **型**: string (複数選択可能)
- **検証状況**: ✅ 検証済み（検索フォーム分析 + 全27種APIテスト）
- **重要な発見**: 過去の調査では順序から推測していたため、ほぼ全て間違っていた。2025-11-07に全マッピングを再調査・修正済み。
- **値**:
  - `1`: ドラゴン族
  - `2`: アンデット族
  - `3`: 悪魔族
  - `4`: 炎族
  - `5`: 海竜族
  - `6`: 岩石族
  - `7`: 機械族
  - `8`: 魚族
  - `9`: 恐竜族
  - `10`: 昆虫族
  - `11`: 獣族
  - `12`: 獣戦士族
  - `13`: 植物族
  - `14`: 水族
  - `15`: 戦士族
  - `16`: 鳥獣族
  - `17`: 天使族
  - `18`: 魔法使い族
  - `19`: 雷族
  - `20`: 爬虫類族
  - `21`: サイキック族
  - `22`: 幻神獣族
  - `23`: 創造神族
  - `26`: 幻竜族
  - `27`: サイバース族
  - `34`: 幻想魔族
- **複数選択**: `species=1&species=15&species=18` のように繰り返す
- **注意**: `24`, `25`, `28`〜`33`, `35`以降は欠番

## モンスター数値範囲パラメータ

### starfr, starto
- **説明**: レベル／ランク範囲
- **型**: integer
- **範囲**: `starfr`（開始）から`starto`（終了）
- **例**: `starfr=4&starto=7`（レベル4〜7）
- **注意**: または `level0`〜`level13` の個別チェックボックスを使用可能（下記参照）

### level0 〜 level13
- **説明**: レベル／ランク個別指定（チェックボックス）
- **型**: string (複数選択可能)
- **検証状況**: ✅ 検証済み（検索フォーム分析）
- **重要な発見**: 各レベルごとに個別のname属性を持つ（`level0`, `level1`, ..., `level13`）
- **値**: 選択時に `level0=on`, `level1=on`, ..., `level13=on` のように送信
- **範囲**: 0〜13の14段階
- **例**: `level4=on&level5=on&level6=on`（レベル4, 5, 6）
- **注意**: `starfr/starto` の範囲指定とは別の方法。どちらかを使用する。

### atkfr, atkto
- **説明**: 攻撃力範囲
- **型**: integer
- **例**: `atkfr=2000&atkto=3000`（攻撃力2000〜3000）

### deffr, defto
- **説明**: 守備力範囲
- **型**: integer
- **例**: `deffr=0&defto=2000`（守備力0〜2000）

### pscalefr, pscaleto
- **説明**: ペンデュラムスケール範囲
- **型**: integer
- **範囲**: 0〜13
- **例**: `pscalefr=1&pscaleto=5`（スケール1〜5）
- **注意**: または `Pscale0`〜`Pscale13` の個別チェックボックスを使用可能（下記参照）

### Pscale0 〜 Pscale13
- **説明**: ペンデュラムスケール個別指定（チェックボックス）
- **型**: string (複数選択可能)
- **検証状況**: ✅ 検証済み（検索フォーム分析）
- **重要な発見**: 各スケールごとに個別のname属性を持つ（`Pscale0`, `Pscale1`, ..., `Pscale13`）
- **値**: 選択時に `Pscale0=on`, `Pscale1=on`, ..., `Pscale13=on` のように送信
- **範囲**: 0〜13の14段階
- **例**: `Pscale1=on&Pscale2=on&Pscale3=on`（Pスケール1, 2, 3）
- **注意**: `pscalefr/pscaleto` の範囲指定とは別の方法。どちらかを使用する。

## リンクマーカーパラメータ

### linkmarkerfr, linkmarkerto
- **説明**: リンクマーカー数範囲（隠しフィールド）
- **型**: integer
- **デフォルト**: `""` (空文字列)
- **注意**: 通常は空で、範囲指定には使用されないようです

### linkbtn1 〜 linkbtn9
- **説明**: リンクマーカー方向指定（チェックボックス）
- **型**: string (複数選択可能)
- **検証状況**: ✅ 検証済み（検索フォーム分析）
- **重要な発見**: 各方向ごとに個別のname属性を持つ（`linkbtn1`, `linkbtn2`, ...）。linkbtn5は存在しない。
- **値**: 選択時に `linkbtn1=on`, `linkbtn2=on`, ..., `linkbtn9=on` のように送信
  - APIは実際の値（1, 2, 3等）ではなく `"on"` を受け取る
- **マッピング**:
  ```
  linkbtn7   linkbtn8   linkbtn9
     ↖️        ⬆️        ↗️
  linkbtn4    [中央]    linkbtn6
     ⬅️                 ➡️
  linkbtn1   linkbtn2   linkbtn3
     ↙️        ⬇️        ↘️
  ```
- **例**: `linkbtn1=on&linkbtn2=on&linkbtn4=on`（左下、下、左方向）
- **注意**: linkbtn5（中央）は存在しない

### link_m
- **説明**: リンクマーカー条件（AND/OR）
- **型**: string (ラジオボタン)
- **値**:
  - `1`: AND（すべてのマーカーを持つ）
  - `2`: OR（いずれかのマーカーを持つ）
- **デフォルト**: `2`

## モンスタータイプ・効果パラメータ

### other
- **説明**: モンスターのその他条件（モンスタータイプ）
- **型**: string (複数選択可能)
- **検証状況**: ✅ 検証済み（検索フォーム分析 + APIテスト）
- **値**:
  - `0`: 通常
  - `1`: 効果
  - `2`: 融合
  - `3`: 儀式
  - `4`: トゥーン
  - `5`: スピリット
  - `6`: ユニオン
  - `7`: デュアル
  - `8`: チューナー
  - `9`: シンクロ
  - `10`: エクシーズ
  - `14`: リバース
  - `15`: ペンデュラム
  - `16`: 特殊召喚
  - `17`: リンク
- **複数選択**: `other=1&other=2&other=9`
- **注意**: `11`, `12`, `13`は欠番

### jogai
- **説明**: 除外条件（otherと同じ値セット）
- **型**: string (複数選択可能)
- **値**: `other`と同じ
- **複数選択**: `jogai=2&jogai=10`

### othercon
- **説明**: その他条件のAND/OR
- **型**: string (ラジオボタン)
- **値**:
  - `1`: AND（すべての条件を満たす）
  - `2`: OR（いずれかの条件を満たす）
- **デフォルト**: `2`

## 魔法・罠効果パラメータ

### effe
- **説明**: 魔法・罠の効果タイプ
- **型**: string (複数選択可能)
- **検証状況**: ✅ 検証済み（検索フォーム分析）
- **値**:
  - `20`: 通常
  - `21`: カウンター
  - `22`: フィールド
  - `23`: 装備
  - `24`: 永続
  - `25`: 速攻
  - `26`: 儀式
- **注意**: `ctype=2`（魔法）または`ctype=3`（罠）と組み合わせて使用

## 発売日パラメータ

### releaseDStart, releaseMStart, releaseYStart
- **説明**: 発売日開始（日、月、年）
- **型**: integer
- **デフォルト**: `releaseDStart=1`, `releaseMStart=1`, `releaseYStart=1999`
- **例**: `releaseDStart=15&releaseMStart=3&releaseYStart=2020`（2020年3月15日）

### releaseDEnd, releaseMEnd, releaseYEnd
- **説明**: 発売日終了（日、月、年）
- **型**: integer
- **デフォルト**: `""` (空文字列、制限なし)
- **例**: `releaseDEnd=31&releaseMEnd=12&releaseYEnd=2023`（2023年12月31日まで）

## URLパラメータの順序

実際のURLでは以下の順序でパラメータが並びます：

```
?ope=1
&sess=1
&rp=10
&mode=
&sort=1
&keyword=
&stype=1
&ctype=
&attr=11&attr=12       # 複数選択時は繰り返し
&species=1&species=15  # 複数選択時は繰り返し
&effe=20
&othercon=2
&other=1&other=9       # 複数選択時は繰り返し
&jogai=2&jogai=10      # 複数選択時は繰り返し
&starfr=
&starto=
&pscalefr=
&pscaleto=
&linkmarkerfr=
&linkmarkerto=
&linkbtn1=1&linkbtn2=2  # 選択されたもののみ
&link_m=2
&atkfr=
&atkto=
&deffr=
&defto=
&releaseDStart=1
&releaseMStart=1
&releaseYStart=1999
&releaseDEnd=
&releaseMEnd=
&releaseYEnd=
```

## 複数選択パラメータの仕様

以下のパラメータは複数選択が可能で、同じパラメータ名を繰り返すことで複数の値を指定できます：

- `attr` (属性)
- `species` (種族)
- `other` (その他条件)
- `jogai` (除外条件)
- `linkbtn1`〜`linkbtn9` (リンクマーカー)

**例**:
```
attr=11&attr=12&attr=14  # 光、闇、炎属性
species=1&species=15     # ドラゴン族、戦士族
other=1&other=9          # 効果、シンクロ
```

## 条件結合パラメータ

複数条件のAND/OR指定：

- `othercon`: `other`と`jogai`の条件結合（`1`=AND, `2`=OR）
- `link_m`: リンクマーカーの条件結合（`1`=AND, `2`=OR）

## 実装上の注意点

1. **rpパラメータの隠し機能**: UIには10/25/50/100しか表示されないが、2000まで指定可能
2. **sortの欠番**: sort=10は存在しない
3. **複数選択の実装**: 配列ではなく、同名パラメータの繰り返しで実装
4. **空文字列パラメータ**: 値が空の場合でもパラメータ名は送信される（`keyword=&ctype=`など）
5. **リンクマーカー**: チェックされたボタンのみがURLに含まれる
6. **言語対応**: request_localeで言語を指定し、ラベルは各言語で返される

## 検証済みテストケース

### 属性検索
- 単一属性: `attr=11` （光属性のみ）
- 複数属性: `attr=11&attr=12&attr=14` （光、闇、炎）

### 種族検索
- 複数種族: `species=1&species=15&species=18` （ドラゴン、戦士、魔法使い）

### 数値範囲
- 攻撃力: `atkfr=2000&atkto=3000`
- 守備力: `deffr=0&defto=2000`
- レベル: `starfr=4&starto=7`
- ペンデュラムスケール: `pscalefr=1&pscaleto=5`

### リンクマーカー
- 複数方向: `linkbtn1=1&linkbtn2=2&linkbtn4=4`
- AND条件: `linkbtn1=1&linkbtn3=3&link_m=1`

### モンスタータイプ
- 複数タイプOR: `other=1&other=2&other=9&othercon=2`
- 複数タイプAND: `other=1&other=9&othercon=1` （効果シンクロ）

### 除外条件
- 複数除外: `jogai=2&jogai=10` （融合とエクシーズを除外）

### 結果表示
- 全結果取得: `rp=2000`
- ソート: `sort=21` （発売日新しい順）

## 今後の調査項目

- [ ] セッション管理の詳細（`sess`パラメータの生成方法）
- [ ] `mode`パラメータの用途
- [ ] ページネーション機能（2ページ目以降へのアクセス方法）
- [ ] エラーハンドリング（不正なパラメータ値の場合の挙動）
- [ ] 他の言語での動作確認（en, ko, zh-CNなど）
